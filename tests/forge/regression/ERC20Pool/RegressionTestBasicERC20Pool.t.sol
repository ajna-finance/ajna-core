// SPDX-License-Identifier: UNLICENSED

pragma solidity 0.8.18;

import { BasicERC20PoolInvariants } from "../../invariants/ERC20Pool/BasicERC20PoolInvariants.t.sol";

contract RegressionTestBasicERC20Pool is BasicERC20PoolInvariants { 

    function setUp() public override {
        // failures reproduced with 3 active buckets
        vm.setEnv("NO_OF_BUCKETS", "3");
        vm.setEnv("BUCKET_INDEX_ERC20", "2570");
        super.setUp();
    }

    function test_regression_Underflow_1() external {
        _basicERC20PoolHandler.addQuoteToken(14227, 5211, 3600000000000000000000, 0);

        // check invariants hold true
        invariant_quote();
    }

    function test_regression_exchange_rate_1() external {
        _basicERC20PoolHandler.addQuoteToken(999999999844396154169639088436193915956854451, 6879, 2809, 0);
        _basicERC20PoolHandler.addCollateral(2, 36429077592820139327392187131, 202214962129783771592, 0);
        _basicERC20PoolHandler.removeCollateral(1, 2296695924278944779257290397234298756, 10180568736759156593834642286260647915348262280903719122483474452532722106636, 0);

        invariant_exchange_rate(); 
    }

    function test_regression_exchange_rate_2() external {
        _basicERC20PoolHandler.addQuoteToken(211670885988646987334214990781526025942, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 6894274025938223490357894120267612065037086600750070030707794233, 0);
        _basicERC20PoolHandler.addCollateral(117281, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 2, 0);
        _basicERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 12612911637698029036253737442696522, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);
        _basicERC20PoolHandler.removeCollateral(1, 1e36, 2570, 0);
        _basicERC20PoolHandler.removeQuoteToken(1, 1e36, 2570, 0);
        _basicERC20PoolHandler.removeCollateral(2, 1e36, 2570, 0);
        _basicERC20PoolHandler.removeQuoteToken(2, 1e36, 2570, 0);

        invariant_exchange_rate();
    }

    function test_regression_exchange_rate_3() external {
        _basicERC20PoolHandler.addQuoteToken(2842, 304, 2468594405605444095992, 0);
        _basicERC20PoolHandler.addCollateral(0, 1, 3, 0);
        _basicERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _basicERC20PoolHandler.removeCollateral(0, 1, 3, 0);

        invariant_exchange_rate();
    }

    function test_regression_exchange_rate_4() external {
        _basicERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 587135207579305083672251579076072787077, 0);
        _basicERC20PoolHandler.removeCollateral(712291886391993882782748602346033231793324080118979183300958, 673221151277569661050873992210938589, 999999997387885196930781163353866909746906615, 0);
        _basicERC20PoolHandler.removeCollateral(4434852123445331038838, 92373980881732279172264, 16357203, 0);
        _basicERC20PoolHandler.addQuoteToken(6532756, 16338, 2488340072929715905208495398161339232954907500634, 0);
        _basicERC20PoolHandler.removeCollateral(934473801621702106582064701468475360, 999999998588451849650292641565069384488310108, 2726105246641027837873401505120164058057757115396, 0);
        _basicERC20PoolHandler.addQuoteToken(0, 3272, 688437777000000000, 0);
        _basicERC20PoolHandler.removeQuoteToken(36653992905059663682442427, 3272, 688437777000000000, 0);

        invariant_exchange_rate();
    }

    function test_regression_exchange_rate_5() external {
        _basicERC20PoolHandler.drawDebt(1156, 1686, 0);
        
        invariant_exchange_rate();
        _basicERC20PoolHandler.addQuoteToken(711, 2161, 2012, 0); 

        invariant_exchange_rate();   
    }

    function test_regression_exchange_rate_6() external {
        _basicERC20PoolHandler.addCollateral(999999999000000000000000081002632733724231666, 999999999243662968633890481597751057821356823, 1827379824097500721086759239664926559, 0);
        _basicERC20PoolHandler.addQuoteToken(108018811574020559, 3, 617501271956497833026154369680502407518122199901237699791086943, 0);
        _basicERC20PoolHandler.addCollateral(95036573736725249741129171676163161793295193492729984020, 5009341426566798172861627799, 2, 0);
        _basicERC20PoolHandler.removeCollateral(1, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 5814100241, 0);

        invariant_exchange_rate();
    }

    // test was failing when actors = 10, buckets = [2570], maxAmount = 1e36
    // Fixed with commit -> https://github.com/ajna-finance/contracts/pull/613/commits/f106f0f7c96c1662325bdb5151fd745544e6dce0 
    function test_regression_exchange_rate_7() external {
        _basicERC20PoolHandler.addCollateral(999999999249784004703856120761629301735818638, 15200, 2324618456838396048595845067026807532884041462750983926777912015561, 0);
        _basicERC20PoolHandler.addQuoteToken(0, 2, 60971449684543878, 0);
        _basicERC20PoolHandler.addCollateral(0, 648001392760875820320327007315181208349883976901103343226563974622543668416, 38134304133913510899173609232567613, 0);
        _basicERC20PoolHandler.removeCollateral(0, 1290407354289435191451647900348688457414638662069174249777953, 125945131546441554612275631955778759442752893948134984981883798, 0);

        invariant_exchange_rate();
    }

    // test was failing when actors = 10, buckets = [2570], maxAmount = 1e36
    function test_regression_exchange_rate_8() external {
        _basicERC20PoolHandler.drawDebt(0, 10430, 0);

        invariant_exchange_rate();
        _basicERC20PoolHandler.addCollateral(86808428701435509359888008280539191473421, 35, 89260656586096811497271673595050, 0);

        invariant_exchange_rate();
    }

    function test_regression_exchange_rate_9() external {
        _basicERC20PoolHandler.addQuoteToken(179828875014111774829603408358905079754763388655646874, 39999923045226513122629818514849844245682430, 12649859691422584279364490330583846883, 0);

        invariant_exchange_rate();
        _basicERC20PoolHandler.addCollateral(472, 2100, 11836, 0);
        
        invariant_exchange_rate();
        _basicERC20PoolHandler.pledgeCollateral(7289, 8216, 0);

        invariant_exchange_rate();
    }

    function test_regression_fenwick_deposit_1() external {
        _basicERC20PoolHandler.addQuoteToken(60321923115154876306287876901335341390357684483818363750, 2, 0, 0);
        _basicERC20PoolHandler.repayDebt(58055409653178, 2, 0);

        invariant_fenwick();
    }

    function test_regression_fenwick_deposit_2() external {
        _basicERC20PoolHandler.addQuoteToken(2, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 2146593659305556796718319988088528090847459411703413796483450011160, 0);
        _basicERC20PoolHandler.addCollateral(16885296866566559818671993560820380984757301691657405859955072474117, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 7764878663795446754367, 0);
        _basicERC20PoolHandler.removeCollateral(999999997000000000000000000000000000000756426, 7366, 4723, 0);
        _basicERC20PoolHandler.addQuoteToken(5673, 8294, 11316, 0);
        _basicERC20PoolHandler.moveQuoteToken(919997327910338711763724656061931477, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 3933155006830995444792575696, 0);

        invariant_fenwick();
    }

    function test_regression_fenwick_deposit_3() external {
        _basicERC20PoolHandler.pullCollateral(64217420783566726909348297066823202824683000164554083, 651944294303386510182040138076901697073, 0);
        _basicERC20PoolHandler.removeQuoteToken(172614182, 2999, 725, 0);
        _basicERC20PoolHandler.addQuoteToken(52646814442098488638488433580148374391481084017027388775686120188766352301, 5021, 16410, 0);
        _basicERC20PoolHandler.moveQuoteToken(2, 1, 3, 11769823729834119405789456482320067049929344685247053661486, 0);
        _basicERC20PoolHandler.moveQuoteToken(1, 2833727997543655292227288672285470, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 7962018528962356191057551420322350, 0);

        invariant_fenwick();
    }

    function test_regression_fenwick_deposit_4() external {
        _basicERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 2, 1267, 0);
        _basicERC20PoolHandler.pledgeCollateral(1700127358962530, 0, 0);
        _basicERC20PoolHandler.moveQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 2, 0);

        invariant_fenwick();
    }

    function test_regression_fenwick_deposit_5() external {
        _basicERC20PoolHandler.repayDebt(281, 1502, 0);
        _basicERC20PoolHandler.addCollateral(5529, 1090, 5431, 0);
        _basicERC20PoolHandler.pullCollateral(3, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);

        invariant_fenwick();
    }

    function test_regression_fenwick_deposit_6() external {
        _basicERC20PoolHandler.repayDebt(115792089237316195423570985008687907853269984665640564039457584007913129639933, 0, 0);
        _basicERC20PoolHandler.addQuoteToken(1000000000000000, 19319, 308, 0);
        _basicERC20PoolHandler.pullCollateral(4218, 4175, 0);

        invariant_fenwick();
    }

    function test_regression_fenwick_prefixSum_1() external {
        _basicERC20PoolHandler.addQuoteToken(5851, 999999999999999999999999999999000087, 1938, 0);
        _basicERC20PoolHandler.addCollateral(135454721201807374404103595951250949, 172411742705067521609848985260337891060745418778973, 3, 0);
        _basicERC20PoolHandler.pledgeCollateral(2, 185978674898652363737734333012844452989790885966093618883814734917759475, 0);
        _basicERC20PoolHandler.moveQuoteToken(976453319, 2825105681459470134743617749102858205411027017903767825282483319, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 145056082857394229503325854914710239303685607721150607568547620026, 0);

        invariant_fenwick();
    }

    function test_regression_fenwick_index_1() external {
        _basicERC20PoolHandler.addQuoteToken(3056, 915, 1594, 0);
        _basicERC20PoolHandler.pullCollateral(274694202801760577094218807, 1, 0);
        _basicERC20PoolHandler.addQuoteToken(1088, 3407, 3555, 0);
        _basicERC20PoolHandler.addCollateral(1557, 13472, 15303, 0);
        _basicERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639933, 40692552539277917058910464963, 0);
        _basicERC20PoolHandler.pullCollateral(1131485716992204156645660898919702, 30971207810832254868222941038507448, 0);
        _basicERC20PoolHandler.removeCollateral(27428712668923640148402320299830959263828759458932482391338247903954077260349, 1136, 3944, 0);
        _basicERC20PoolHandler.moveQuoteToken(9746204317995874651524496302383356801834068305156642323380998069579800880, 1723109236200550802774859945265636287, 3213180193920898024510373220802133410941904907229061207617048152428481, 0, 0);

        invariant_fenwick();
    }

    function test_regression_transferLps_1() external {
        _basicERC20PoolHandler.transferLps(0, 1, 200, 2570, 0);

        invariant_bucket();
    }

    function test_regression_transferLps_2() external {
        _basicERC20PoolHandler.transferLps(37233021465377552730514154972012012669272, 45957263314208417069590941186697869465410494677646946058359554, 405, 89727160292150007024940, 0);

        invariant_fenwick();
    }

    function test_regression_transferLps_3() external {
        _basicERC20PoolHandler.transferLps(1795, 6198, 3110, 11449, 0);

        invariant_bucket();
        invariant_exchange_rate();
    }

    function test_regression_pull_collateral_when_encumbered_greater_than_pledged() external {
        _basicERC20PoolHandler.drawDebt(1535776046383997344779595, 5191646246012456798576386242824793107669233, 0);
        _basicERC20PoolHandler.transferLps(17293, 19210, 227780, 999999999999999999999999999999999999999999997, 0);
        _basicERC20PoolHandler.removeQuoteToken(0, 0, 2, 0);
        _basicERC20PoolHandler.pullCollateral(115, 149220, 0);
    }

    function test_regression_incorrect_zero_deposit_buckets_1() external {
        _basicERC20PoolHandler.repayDebt(15119, 6786, 0);
        _basicERC20PoolHandler.moveQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639932, 1578322581132549441186648538841, 2, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);
        invariant_fenwick();
    }

    function test_regression_fenwick_index_2() external {
        uint256 minAmount = vm.envOr("MIN_QUOTE_AMOUNT_ERC20", uint256(1e3));
        uint256 maxAmount = vm.envOr("MAX_QUOTE_AMOUNT_ERC20", uint256(1e30));
        uint256 quotePrecision = vm.envOr("QUOTE_PRECISION", uint256(18));
        uint256 scale = 10 ** (18 - quotePrecision);
        uint256 depositAt2570 = (_basicERC20PoolHandler.constrictToRange(570036521745120847917211, minAmount, maxAmount) / scale) * scale;
        uint256 depositAt2571 = (_basicERC20PoolHandler.constrictToRange(2578324552477056269186646552413, minAmount, maxAmount) / scale) * scale;
        uint256 depositAt2572 = (_basicERC20PoolHandler.constrictToRange(1212, minAmount, maxAmount) / scale) * scale;
        _basicERC20PoolHandler.addQuoteToken(1, depositAt2570, 2570, 0);
        _basicERC20PoolHandler.addQuoteToken(1, depositAt2571, 2571, 0);
        _basicERC20PoolHandler.addQuoteToken(1, depositAt2572, 2572, 0);
        assertEq(_pool.depositIndex(depositAt2570), 2570);
        assertEq(_pool.depositIndex(depositAt2570 + depositAt2571), 2571);
        if (depositAt2572 != 0) {
            assertEq(_pool.depositIndex(depositAt2570 + depositAt2571 + depositAt2572), 2572);
        }
    }

    function test_regression_collateralBalance_CT1_CT7() external {
        _basicERC20PoolHandler.pullCollateral(2, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);
        _basicERC20PoolHandler.repayDebt(2712912126128356234217, 251720382485531952743041849848, 0);
        _basicERC20PoolHandler.addQuoteToken(253022590763482364356576159, 999999999999999273028438503236995092261608400, 712808213364422679443324012750, 0);
        _basicERC20PoolHandler.removeQuoteToken(121890555084215923472733925382, 0, 3, 0);

        invariant_collateral_CT1_CT7();
    }

    function test_regression_invariant_quote() external {
        _basicERC20PoolHandler.pledgeCollateral(47134563260349377955683144555119028889734284095914219439962386869, 2323610696462098, 0);
        _basicERC20PoolHandler.repayDebt(1, 2, 0);
        _basicERC20PoolHandler.removeCollateral(200953640940463935290718680397023889633667961549, 2481, 3, 0);
        _basicERC20PoolHandler.moveQuoteToken(695230664226651211376892782958299806602599384639648126900062519785408512, 1000115588871659705, 22812, 1955101796782211288928817909562, 0);
        _basicERC20PoolHandler.repayDebt(115792089237316195423570985008687907853269984665640564039457584007913129639932, 103, 0);

        invariant_quote();
    }

    function test_regression_fenwick_deposit_8() external {
        _basicERC20PoolHandler.drawDebt(226719918559509764892175185709, 228676957600917178383525685311331, 0);

        invariant_fenwick();
    }

    /*
        Test was failing due to paralel fenwick-like structure rounding issues when removing quote token (pool zeroed out deposit, invariant didn't).
        Fixed by always updating fenwick-like structure deposit before _removeFenwick with pool value of deposit before action.
    */
    function test_regression_removeQuote_F1_F2() external {
        _basicERC20PoolHandler.drawDebt(1000015842906285642, 3025860345093137767157722073974970, 1672579009);
        _basicERC20PoolHandler.pullCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639935, 37350737096356631749868658766446035802507688889, 3);
        _basicERC20PoolHandler.pullCollateral(1339025589888540701846672565416819, 1183378320242304355226217089860, 2819684456210673680471842519329612269717114425950956824633610867);
        _basicERC20PoolHandler.drawDebt(1675397941, 2080415307674929935089938650133, 847585073183503135184199206179);
        _basicERC20PoolHandler.removeQuoteToken(3, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 1655863997176315188863510439876677338937555872044147015301945, 130646460818);
        _basicERC20PoolHandler.addQuoteToken(3, 159910559897732110834294450390998113542066344214, 693859041495743005167828576510678370114547542712821651478979861149724, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _basicERC20PoolHandler.repayDebt(625581645905633082032893062740, 2725046641108356153623398492984047, 2255219883038810127965464888694355);
        _basicERC20PoolHandler.removeQuoteToken(1000000905589942863, 58990072763305399289367199366, 923788618229907811082240816581, 1000495950425598387);
        _basicERC20PoolHandler.removeQuoteToken(1000142773576820584, 688076943001126469299127368281324660985333148061425170456167973348260210, 1000477901104615870, 4102539298994246948557383554220941);
        _basicERC20PoolHandler.repayDebt(115792089237316195423570985008687907853269984665640564039457584007913129639935, 58723896542, 1);
        _basicERC20PoolHandler.pledgeCollateral(48301739701121795424890239903547, 3, 1324680083965641189506583054831958046966);
        _basicERC20PoolHandler.moveQuoteToken(3426269639726768233918196638236, 1000211552600857667, 5685060712659462532718722585403826, 2792178365459745443619626179409076, 1426463916295788240829761693142813153335606622714154151);
        _basicERC20PoolHandler.drawDebt(1675845589, 2250075795681149832645315047529352966150920489023882737068264887430, 1874793830451667442216647666);
        _basicERC20PoolHandler.removeQuoteToken(2724859996648816227289710015353665, 1390991014546251119747341814610, 218948663391604015591297550517, 2539235686535710401520960977679);
        _basicERC20PoolHandler.removeCollateral(31352472016259312240697112201650738620289868213389321043778, 3134900229522813154679985060039980, 107, 60051311522860524551173770709758822540903524);
        _basicERC20PoolHandler.removeCollateral(2531436685989521387110557039659278081045704440673059845141681786228450255542, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 9794596782419650685386956056211712555152081175635316977567188779967260798, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.addCollateral(2266260600185984418754485132, 7324720411794446825398360654973, 576574478079656391612100683, 1674425576);
        _basicERC20PoolHandler.removeQuoteToken(40743146231596996553946362499, 1000217577936384416, 9434697404733431344495466234349364, 1000022296421718800);
        _basicERC20PoolHandler.pledgeCollateral(1673388362, 1255031423241829518578475157835, 1523773071159963043);
        _basicERC20PoolHandler.transferLps(4034401368985456464882679572223864289378810567697, 81652242414390102183801448266756157323151608634669327038615887558, 24740306543212756820262332217300728040, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.transferLps(4495787, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 3, 147086922704227907905118942315866593, 54737);
        _basicERC20PoolHandler.moveQuoteToken(474980413008325149341966443575545671819998168600255, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 1, 70, 1113832091799835307);
        _basicERC20PoolHandler.addCollateral(188050718044765422696838279498755220148332129109203942249845704311, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 346011456129608788132194365321197, 441);
        _basicERC20PoolHandler.transferLps(5080949979479159164174260135879, 3471313089256649147043990966762, 3577613940211944321385119245030, 2638375712381213697694391111978, 1000080461883002399);
        _basicERC20PoolHandler.drawDebt(1354503559178321571, 1000304971444839895, 999999999999999967588142846479439157680058501);
        _basicERC20PoolHandler.pledgeCollateral(8576431004957223069174121487463, 978494819882708200561056462237, 936854891036552091003084);
        _basicERC20PoolHandler.pledgeCollateral(3, 3, 3028035929838919741732787237);
        _basicERC20PoolHandler.addQuoteToken(11460673144393961829630519848597906, 1442520032722081788192223127751471, 3348011182322008809621454756788, 2000125990203969564606281941576);
        _basicERC20PoolHandler.moveQuoteToken(4297449451578893941161320879546434, 2712969274693577552070, 2730448071256681602025639939798518, 3427811744873070004193423338400, 23360);
        _basicERC20PoolHandler.transferLps(115792089237316195423570985008687907853269984665640564039457584007913129639932, 258478163207917, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 42859325144530938385330793634625932568274198052665103043091136354, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 6292417211010384270261130544608442839047244830, 1641951090342790424051404204860104821855830761498357810286270, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.removeCollateral(13779450658675671982760604652, 689052320352616146813931342190450782529875553448303105413508080522051734, 788151799776458826759410795283, 1000126756434716682397388);
        _basicERC20PoolHandler.removeCollateral(1283235964548610178080671680029, 6243437121190289325501914157239, 2089119602715976701960815485980, 1673298601);
        _basicERC20PoolHandler.addCollateral(4267105210518626985539574, 1, 28664277169404984418780329020002445783985631994239934152836875808532090654366, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.pledgeCollateral(175213099448262185950098697987994, 11405870109131830270938242, 596778938571738970749024097943683093900241802300951);
        _basicERC20PoolHandler.pullCollateral(1675373528, 1000643193057265125, 851515825605428609864032636);
        _basicERC20PoolHandler.addCollateral(1000842547065757957, 1229498646011360052230106757967935, 884554933107357871431160708688362, 10906075423212449089453170567425599998163241130742492718419782121361707);
        _basicERC20PoolHandler.removeQuoteToken(1000438325294591924, 3582795110651102560026236555318, 8665091894100610806039181174059, 246314140342906321626131758080816);
        _basicERC20PoolHandler.moveQuoteToken(3, 1025481480085320059204662854, 2, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 371305751270977601367562503751);
        _basicERC20PoolHandler.pullCollateral(1, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 6946638055104596203629012810357409865808562690004754842595629672415209263);
        _basicERC20PoolHandler.addCollateral(1002873997273952492851504, 2385643760429624075847487294213310, 2490767567338070980047347237144, 333957999640872228540656713280354);
        _basicERC20PoolHandler.transferLps(1637629916243, 10417426262, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 1988449019663501439965118138231426045376, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.pledgeCollateral(857212141121873485584263527487519, 7674477408232134928658984923592, 787980176546695109273776259971);
        _basicERC20PoolHandler.addCollateral(713801469281338696586614702364913293893160869, 0, 18080511835644090989, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.addCollateral(1000371012982238982, 1002409928637823858, 238058853766351065, 137587133116990005892644308);
        _basicERC20PoolHandler.removeQuoteToken(93248165328, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 13155892587552843036592082640560683541082937613429066256638, 111358472563932965209322901361175289443134);
        _basicERC20PoolHandler.drawDebt(1327861028789336135096064693246, 800871846833446413968021157289, 3317423511422177200707956428749);
        _basicERC20PoolHandler.pledgeCollateral(2682017609095556511622, 5556520063677865508187579952868, 1000000028214733769);
        _basicERC20PoolHandler.addCollateral(134911182544886496485676, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 26164644739224690259952183454);
        _basicERC20PoolHandler.addQuoteToken(0, 31050797470978541429891547263060, 57074598730088502317475702631679744093433386981422137, 822481412380084455191882241184106286198835081035492479743769360185712);
        _basicERC20PoolHandler.drawDebt(1675030096, 7706394381985344917459187161880, 1000017177972882151);
        _basicERC20PoolHandler.removeCollateral(2456818873105471961911772787, 1001440041141746185288759, 3000424147352546277098658253583, 432773833504460);
        _basicERC20PoolHandler.removeQuoteToken(1471263305301696626176, 2435881105068041950392319046045, 1000000007348008219, 999999999999999144967774987089662894676005576);
        _basicERC20PoolHandler.moveQuoteToken(102030598360846849321306416093340647568905401223531345036095935, 2364859774704771817, 2075258113061, 0, 0);
        _basicERC20PoolHandler.addQuoteToken(3728461598084869758383, 7707264601395910711647785890664941538958957616950303047136388112, 3, 18680203764077861657588263992104251745159180970777695534619138974096574);
        _basicERC20PoolHandler.repayDebt(2, 722249219365013579691268, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _basicERC20PoolHandler.moveQuoteToken(980769234693041870485054699244, 1970988111392301049311821556405490226232593598043135198982826388509, 383821809833879542970855447995, 6766725109469402021972726993647, 9021319146842901668448861113286);
        _basicERC20PoolHandler.pledgeCollateral(1696102854909895122057327133768, 814308106147626392548961465108306, 75777074020720139048286873345);
        _basicERC20PoolHandler.moveQuoteToken(1000002753364534949, 7613360930324894103638362138205474, 1673423154, 1000095697465428287, 3081229597731649318700002357589452);
        _basicERC20PoolHandler.pledgeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 3663078937159, 878852633793063524);
        _basicERC20PoolHandler.pullCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639935, 50199796429304219, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.removeQuoteToken(54952481677113727684785865172239237207389554174800588163114107355108498411, 49521351703439422140488134804268608481883222138549038690280691426, 1, 2);
        _basicERC20PoolHandler.pullCollateral(1674801100, 688457829586514166182911021152980393464072006914979240821230092238474296, 191459120967260738890684);
        _basicERC20PoolHandler.removeQuoteToken(1000000000000000226275645567255865851052308968, 1000033995284293618, 1673523428, 205679958867810410961091789);
        _basicERC20PoolHandler.repayDebt(4283770176908571600780888289937, 3878801933482034411823652362701, 6397354869802509622840628836744);
        _basicERC20PoolHandler.removeCollateral(5, 2, 3, 1);
        _basicERC20PoolHandler.removeQuoteToken(1481218076834943080930743418348884607278626092957285426, 4944624679196338188027773190, 302213701184203129511700286555824220787165073271463205578917, 11598724614654186194135964033552800569100655);
        _basicERC20PoolHandler.drawDebt(3175, 376537109871115643414854480, 7045500779068980260852831480795);
        _basicERC20PoolHandler.repayDebt(39672830182321736175837, 1197001277357796117816307860477585809, 1276146741755657434550801492102585923);
        _basicERC20PoolHandler.removeCollateral(2, 3, 149720885657, 4481904462987774222638773175857655439883276713);
        _basicERC20PoolHandler.transferLps(3, 2, 3, 92697654460289264975012691299736198312035163822654217310697740435413049, 107613895494373421311268449752330);
        _basicERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 261, 4401564682114406193562877932070957164878886601249285706596727702229506, 3080523217971253852);
        _basicERC20PoolHandler.pledgeCollateral(882302277218841710922942058583861947472479522728846415389137525832817, 1122, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.pullCollateral(2276702435456921800137116720705939408780087138052348, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 2);
        _basicERC20PoolHandler.moveQuoteToken(69478512381062333, 26018993921432954032706306348, 3972, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639933);
        _basicERC20PoolHandler.pullCollateral(555221921173742694714, 3, 4290216928066323203007906558975436091131586796);
        _basicERC20PoolHandler.drawDebt(1000001755546083949, 4152023560094690172177358655923, 776590240941700179123128112651947);
        _basicERC20PoolHandler.addQuoteToken(10911643530470, 11571512411400883492970753272389218201362653263376690028965772507793764535, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 433646946410789123186196737932199367502396042059149665043277612077742789);
        _basicERC20PoolHandler.removeQuoteToken(1014170807017615452972515392, 688902077970386073426553893267979679281355730995775397815873676452908639, 805107887347601724928444946, 4525185621542521411470683258470);
        _basicERC20PoolHandler.moveQuoteToken(3745834598333182492912258260374413, 688255790011828735871738618110580749936356337902873119393264231395094242, 569198639876296340303271420533, 1000319071122041164, 135192106979847526512828998297);
        _basicERC20PoolHandler.addQuoteToken(1, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 529753993999390054394486713090179228954416870337090505, 1136341150615122739427713817422473634220079895919156654404240);
        _basicERC20PoolHandler.removeQuoteToken(999999999912894033768372883742, 999999999999999999504047943293631522569691684, 688447880865960602171180152209302651722918881293935619220696025762456064, 5242473368138304085708695872797);

        invariant_fenwick();
    }

    function test_regression_no_LP_on_remove_quote() external {
        vm.setEnv("QUOTE_PRECISION", "12");
        super.setUp();
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.repayDebt(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 2);
        _basicERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639935, 2, 21301506904137025678, 2);
        _basicERC20PoolHandler.drawDebt(3113594730498081967626732580815715041136, 80477440056595338652394034532720707, 1629103681429080141429902583796629444390345533658);
        _basicERC20PoolHandler.pullCollateral(80971119364652613288528890753630400505402891191345876238644064519478371635555, 613023803989253543303681985611422219128065442948859376011994400396, 70630968035528998923451178264359);
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.removeCollateral(18446744121342263227, 10343, 10718, 1584);
        _basicERC20PoolHandler.moveQuoteToken(6727, 1670, 3625, 6846, 8977);
        _basicERC20PoolHandler.addCollateral(255660578852971, 2707, 10605, 6240);
        _basicERC20PoolHandler.transferLps(39770824717966450577403984099027230651590596354753451, 110196468889211344788237137729753052337259399844499670601, 791373455, 286888477198921971336421055248818459653848892272862019791291708522096335138, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _basicERC20PoolHandler.removeQuoteToken(16539, 849, 4183, 3654);
        _basicERC20PoolHandler.transferLps(0, 231721612610995347269444530139919228024957364865779244666407080, 4794, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 2393963802041534052680824498183);
        _basicERC20PoolHandler.pullCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 1);
        _basicERC20PoolHandler.removeCollateral(53, 246, 10960, 349862589541);
        _basicERC20PoolHandler.drawDebt(1478,3080, 7691);
        _basicERC20PoolHandler.drawDebt(2605,7549, 695);
        _basicERC20PoolHandler.pullCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639935, 938657598529153312558550293408527955690427754981926333818300781429629, 3);
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.removeQuoteToken(7770, 6011, 9016, 258);
        _basicERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 2335090198565709662059293854, 712717023986, 3);
        _basicERC20PoolHandler.addCollateral(3136, 1363882257, 95, 10000000000000000000000000000000000000000000000);
        _basicERC20PoolHandler.transferLps(2, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 13715229545702433012291230563878099218863282810259481425393174710971712785);
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.moveQuoteToken(1, 15465987, 0, 727881530902743346146211643722166235127357858050164982344259, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.repayDebt(0, 1, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.addCollateral(3587, 1507, 3709, 2202654398);
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.transferLps(115792089237316195423570985008687907853269984665640564039457584007913129639935, 71353554542511499288031498857245628545083183911704, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 9266, 29822756335928881365955885003131297976103);
        _basicERC20PoolHandler.moveQuoteToken(1, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 427490373, 0, 2);
        _basicERC20PoolHandler.moveQuoteToken(15946, 8224, 37904, 10719, 6431);
        _basicERC20PoolHandler.moveQuoteToken(5209, 2559, 267, 22010, 1124);
        _basicERC20PoolHandler.pledgeCollateral(1560275422, 5664, 615);
        _basicERC20PoolHandler.repayDebt(843,19783, 2319);
        _basicERC20PoolHandler.pledgeCollateral(47670601452294692829969261558187945, 0, 85156819749408383319049410354);
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.addQuoteToken(9739, 11264, 30366981136777812418611175058, 9064);
        _basicERC20PoolHandler.repayDebt(5497, 3546, 6167);
        _basicERC20PoolHandler.pledgeCollateral(10475, 9492, 38563662178380998846027553303678307422644286056268047356605934509250899345408);
        _basicERC20PoolHandler.removeQuoteToken(3, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 1, 95423117699148416952018405033222622105782443444738280);
        _basicERC20PoolHandler.drawDebt(11206, 1426, 6248);
        _basicERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 8788124134869901850295874353438558867392764682597931, 0);
        _basicERC20PoolHandler.pullCollateral(12854, 2146, 8151);
        _basicERC20PoolHandler.pledgeCollateral(2839, 29969932493659093579519920003174532321574847349413477474170341246533839618048, 5796);
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.drawDebt(14989958369421102388335172247459751877787212, 21862705576, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.removeQuoteToken(2, 2, 2, 4142645485845561527335341889839117689693);
        _basicERC20PoolHandler.removeQuoteToken(111805043895826488886480863100, 11765, 21788, 727881530902743346146211643722166235127357858050164982344259);
        _basicERC20PoolHandler.moveQuoteToken(531707326547676289107941, 215495, 2, 2683196030160028724787004357495134006312809522374207033376, 1677458363064960922826783);
        _basicERC20PoolHandler.moveQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639933, 539751760481215767, 118822203799778002136, 3, 1);
        _basicERC20PoolHandler.transferLps(995000000000000000, 2482, 12809, 1812, 811680264765698944396479178993);
        _basicERC20PoolHandler.addCollateral(1147, 2805, 2520, 76876699529364196847806544444508040664462721441447668877111153141084241089631);
        _basicERC20PoolHandler.removeQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639935, 754369339485602608231535452844762957245952811484904409682134372011147, 90655833348315767703, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639933, 82920038770960379924898829, 585789243426828016689519910950913663323834833546853232, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _basicERC20PoolHandler.transferLps(1, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 1, 2);
        _basicERC20PoolHandler.removeQuoteToken(1372, 23433, 6878, 7654);
        _basicERC20PoolHandler.pullCollateral(2, 2, 1);
        _basicERC20PoolHandler.addQuoteToken(8291, 8290, 1055712152538152708419638138217, 15983);
        _basicERC20PoolHandler.moveQuoteToken(688139553215404123198126833242494081254034862424060628945165937332976374, 23798, 1175, 30447600420829968275313533, 13574);
        _basicERC20PoolHandler.repayDebt(1000000009657080804, 10455, 119976781030095520858224948620);
        _basicERC20PoolHandler.addCollateral(349761991217256439351133488173955013978420919767938543, 0, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _basicERC20PoolHandler.repayDebt(4674, 8970, 19838);
        _basicERC20PoolHandler.removeQuoteToken(2453, 9986, 2313, 2688464379803803823822);
        _basicERC20PoolHandler.pullCollateral(1864, 1491, 8078);
        _basicERC20PoolHandler.drawDebt(24173, 3006, 6226);
        _basicERC20PoolHandler.removeQuoteToken(6475, 1914, 500187518239804032900641, 9129);
        _basicERC20PoolHandler.addQuoteToken(2536082571842740939923768090551, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 162527070496019397656824549615422854338062535737450, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.moveQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 672954115360091165463987237600383569196788, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.drawDebt(12262, 1000285187436492128, 9836);
        _basicERC20PoolHandler.removeQuoteToken(5207, 1799, 1589, 644);
    }

    /**
        Test was failing because Pool.getExchangeRate function didn't use enough precision.
        Change to use lpToQuoteToken in order to calculate exchange rate.
     */
    function test_regression_exchange_rate_formula() external {
        _basicERC20PoolHandler.addQuoteToken(1, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 1, 2923022768589903009721855852683522485648049861924540);
        _basicERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 2, 3, 3);
        _basicERC20PoolHandler.transferLps(115792089237316195423570985008687907853269984665640564039457584007913129639933, 321539959172737441322972067598001, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 88006207722779462423, 115792089237316195423570985008687907853269984665640564039457584007913129639933);
        _basicERC20PoolHandler.pullCollateral(23488, 24084, 10807);
        _basicERC20PoolHandler.removeQuoteToken(2, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _basicERC20PoolHandler.drawDebt(10913955608949860504166941743625206520818273863140979320, 2389127265076425122065537258537946033185396562305775, 2);
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.removeCollateral(267606130535933, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 10, 3);
        _basicERC20PoolHandler.moveQuoteToken(38070668420859363138167488234451938667418426275526261134111469869621448555169, 6225, 3498, 23697, 5054);
        _basicERC20PoolHandler.pullCollateral(18111, 373, 500000000);
        _basicERC20PoolHandler.removeCollateral(11102, 4344, 867, 7015);
        _basicERC20PoolHandler.pullCollateral(19453, 960653276687538929172835136434361334704054994070, 3523);
        _basicERC20PoolHandler.removeQuoteToken(13745, 13883, 11404, 21290);
        _basicERC20PoolHandler.addQuoteToken(177271285744156290703877924114956860952917702449152142, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 2, 3);

        invariant_exchange_rate();
    }

    /**
        Test failing due to roundings between roundings while converting unscaled and scaled amounts.
        Fixed by using floorWmul to calculate available scaled deposit and ceilWdiv for calculating unscaled amounts to be removed.
     */
    function test_regression_removeQuote_unexpected_error_roundings() external {
        _basicERC20PoolHandler.failed();
        _basicERC20PoolHandler.transferLps(890167980584982013986877333004, 2713067345438868404572, 8921364168581080226774840568, 1000078569090566833, 353537210282);
        _basicERC20PoolHandler.addCollateral(2, 1, 923897528878347406287558239338201320129238, 1);
        _basicERC20PoolHandler.pullCollateral(1876966384246053957090246468488, 1672464402, 688052353815150279186937936038087410857399564793701041463835021008425807);
        _basicERC20PoolHandler.removeCollateral(10112608317338025841241, 3848488134519109814288430739793139512311996293791690039883385048031418946032, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);
        _basicERC20PoolHandler.addCollateral(2, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 3, 178283908935);
        _basicERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639934, 46284283765526919223101915967198306877948969547477012898722123004373014386, 2);
        _basicERC20PoolHandler.addCollateral(1451401189377100341205495415614, 1169045107259077742759596, 83790417718222297, 5000421930963327126032608);
        _basicERC20PoolHandler.drawDebt(0, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _basicERC20PoolHandler.removeCollateral(787980178697424804260644669041, 4650011139241655705800919147115583985, 56242939, 11563405379609158536853662);
        _basicERC20PoolHandler.moveQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 9864706778039350, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 398323718126437525453671325832071907150961577948074);
        _basicERC20PoolHandler.pledgeCollateral(860035909872273733519244115406, 5280536718533422101017413, 6605758120293762721077586980);
        _basicERC20PoolHandler.addCollateral(12039, 563540416360829910696154009, 217083995893048613404023980, 393);
        _basicERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639935, 2, 1090395, 359479886135243516029204473612122107249203787319729697458343622855875217688);
        _basicERC20PoolHandler.removeCollateral(371563360420901718194118221336, 1645802292118979065257432213924, 688287308006119666252270054390303453427928777225643464981991576931152976, 15708966861989580);
        _basicERC20PoolHandler.addQuoteToken(1000000000006034751383587702240, 6128350080130232109871805848645, 142903725079840157150500091366934271513700494513, 783211348907470516608240);
        _basicERC20PoolHandler.removeQuoteToken(1000000000000000000000001628709, 1000132022000300974, 11652, 3817251874958918198);

        invariant_fenwick();
    }

    /**
        Test failing due to Fenwick rounding change to mulDiv added with https://github.com/ajna-finance/contracts/commit/c9d02cac61719c6fa5a0528578b37b23ec442ee2
        Fixed by updating _invariant_F3 to use ceilWmul instead wmul
     */
    function test_regression_removeQuote_unexpected_error_roundings_1() external {
        _basicERC20PoolHandler.removeQuoteToken(2, 383243191021391787240856517752086232814123441004, 2, 3);
        _basicERC20PoolHandler.drawDebt(3377037550264809545607460158266, 1146851734150908100098809646161, 6511720386880882097636666);
        _basicERC20PoolHandler.moveQuoteToken(999999999999999999999999999413572064001575427, 13383, 6346201736509182528, 69693289665142588160477857912778263228979018150251496691178544388382989895110, 2015961379367446012775);
        _basicERC20PoolHandler.removeQuoteToken(3920437894032211449407747, 1000000000287635958, 503616591236902414213810153623, 9235);
        _basicERC20PoolHandler.repayDebt(7688137144553269111753535591822328734347334706498069397965388498099, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.addCollateral(9192, 1000001426754111526999999999004, 16269065027765148760201233783996, 640566326930800584068303173722);
        _basicERC20PoolHandler.removeQuoteToken(1, 3, 2, 0);
        _basicERC20PoolHandler.removeQuoteToken(192037685235465944208187, 9334600036877208757813033359, 4848096116876706022783653, 25541264921137534184184819141);
        _basicERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 7994570649, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 3);
        _basicERC20PoolHandler.moveQuoteToken(297059547050038230014090027145427135430764, 1672603642, 1672615097, 500420704290143255, 4682031523740261854098418);

        invariant_fenwick();
    }

    /**
        Test failing due tighten F1 and F2 invariants in https://github.com/ajna-finance/contracts/commit/c64058c775d806e0693308247b6b2eb59a748f36#diff-2d6f15f173d5215b0579447b607a778c3a1f31f18caf370e516c603cdddad35bR369
        since using quote token scale means 18 decimal deviation equals 1. Fixed by updating invariants to use a min deviation of 1e12.
     */
    function test_regression_removeQuote_unexpected_error_roundings_2() external {
        _basicERC20PoolHandler.drawDebt(2276458491362276216117814291, 1811389658421886693669, 22761);
        _basicERC20PoolHandler.pullCollateral(688169278021103712794373831144550092872894496810421399363662677745689088, 612986856634992664893744504, 1103042729736385164325032282);
        _basicERC20PoolHandler.pullCollateral(1794910046488915570415053188247, 11140, 65193);
        _basicERC20PoolHandler.moveQuoteToken(1617908970744175286454689045222, 17377, 1787979587169288468655247125588, 688132022563797542698674911026030107539448808933371556866851958732338171, 7982708538520037310059437694);
        _basicERC20PoolHandler.removeCollateral(999999999999998999996317241882478958583189494, 85863611924255325774942689903378117877855490941662314992886331835566406979469, 35568, 333213661536294696016682347868);
        _basicERC20PoolHandler.pledgeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639933, 2, 2475697673632181501713301157571543888586164859205409);
        _basicERC20PoolHandler.pledgeCollateral(1443, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 154158342143283297995448001820);
        _basicERC20PoolHandler.removeQuoteToken(218062810163039837076863627956899968194202633471519079988941952002532, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, 115792089237316195423570985008687907853269984665640564039457584007913129639933);

        invariant_fenwick();
    }

    /**
        Test was failing because LUP index calculated in PoolInfoUtils was different than the LUP index used in the pool, due to inconsistent roundings.
        This happened because in Pool.debtInfo function (used by PoolInfoUtils) the pool debt is always rounded up by using `ceilWmul` while in Pool._accruePoolInterest it was rounded to nearest (by using plain `wmul`).
        Fixed by updating invariant logic to use wmul when calculating debt / lup.
     */
    function test_regression_failure_LUP_mismatch() external {
        _basicERC20PoolHandler.drawDebt(4, 1, 42459383782278435142046724305658135311267691438915386859799265271);
        _basicERC20PoolHandler.addCollateral(2, 3572424784607357932832428669711146305449422791284409705, 1, 1752415137925225987066876882519442642128283316);
        _basicERC20PoolHandler.addCollateral(30078934951760, 0, 2, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.moveQuoteToken(2, 11207742869589877097265928651764717357996863058171818762054716764203431567, 6796354451919795359973416899961151626146, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 32814191648934779166830307328480393297962496735);
        _basicERC20PoolHandler.pledgeCollateral(3, 20079583599722223374347036794412006835499328132, 6223592858454677803546394015384818276973676161160300268239);
        _basicERC20PoolHandler.removeQuoteToken(28027, 640566200129155933206676634319, 1000078878247711703, 688108825063300706996495631347979005290704814814505786503857665710213120);
        _basicERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 3, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639934);

        _invariant_F1();
    }

}

contract RegressionTestBasicWith10BucketsERC20Pool is BasicERC20PoolInvariants { 

    function setUp() public override {
        // failures reproduced with 10 active buckets
        vm.setEnv("NO_OF_BUCKETS", "10");
        super.setUp();
    }

    function test_regression_10_buckets_CT1_CT7() external {
        _basicERC20PoolHandler.transferLps(19078983173372942890417748018722377435183373748499322243247546781962442185, 1, 4391160926701505967325397265181132015972183318, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _basicERC20PoolHandler.transferLps(270997981512080867078682324706934707221242205867293069, 7864, 3651, 3166, 0);
        _basicERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639934, 3635889843872116931397407365290249, 23021664368573277020436789355588670855277006870, 0);
        _basicERC20PoolHandler.drawDebt(268, 181582671641966396883195899256, 0);
        _basicERC20PoolHandler.pullCollateral(1227515749685864358137095510127654245525351748189001609, 3818828157139154512, 0);
        _basicERC20PoolHandler.repayDebt(3042268540744255610589705434124741203255613373849507141, 0, 0);
        _basicERC20PoolHandler.pullCollateral(6802, 6279, 0);
        _basicERC20PoolHandler.addQuoteToken(2, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 127935328935713960735227335223838560292175, 0);
        _basicERC20PoolHandler.pullCollateral(2930, 36104017659498278503100244564470932293, 0);
        _basicERC20PoolHandler.addQuoteToken(1681414255953633817920736095340458401, 2, 331564777626112378272493610241099454882166422929878794700, 0);
        _basicERC20PoolHandler.addCollateral(1834, 38146939, 39424949171633211915315804, 0);
        _basicERC20PoolHandler.addQuoteToken(8640216505061661298, 13070, 10696, 0);
        _basicERC20PoolHandler.pullCollateral(962704044, 8898752, 0);
        _basicERC20PoolHandler.moveQuoteToken(34331296, 236168072844073492133156025194, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 19256400511825415508859240250358, 0);
        _basicERC20PoolHandler.transferLps(2, 1183061996845258949, 3, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _basicERC20PoolHandler.repayDebt(115792089237316195423570985008687907853269984665640564039457584007913129639935, 2, 0 );
        _basicERC20PoolHandler.drawDebt(2169832191680919598423992113933409675947, 459159100237615494082512466719091280519979494228, 0 );
        _basicERC20PoolHandler.pledgeCollateral(363165343283932793766391798512, 14747, 0 );
        _basicERC20PoolHandler.removeCollateral(3985, 1824, 6960, 0);
        _basicERC20PoolHandler.addCollateral(1650938994639952252010012965502, 7253, 7574, 0);
        _basicERC20PoolHandler.transferLps(190195262656118760688724739, 999999999999999999999999999999999999999997115, 1248306590932896398273554030427, 6130, 0);
        _basicERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639935, 8113004849018889317737081296151463737388429, 0);
        _basicERC20PoolHandler.repayDebt(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0 );
        _basicERC20PoolHandler.moveQuoteToken(3, 2, 10960996744849996375050327179144415056797335841576787, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _basicERC20PoolHandler.transferLps(1, 743324445647492969999445842202717517856825, 1214649867011363567867599949068071550706, 239704513237, 0);
        _basicERC20PoolHandler.moveQuoteToken(78781837290735535753552291770891423860043710162602546000110480894858317836924, 993620562130177991745562150, 50000000000000000, 7110950, 0);
        _basicERC20PoolHandler.removeQuoteToken(3201781718151524032696177608091, 2788940717158963266260644637275, 1001719209787209063137009778273, 0);
        _basicERC20PoolHandler.removeCollateral(1481112300711317586348171215820373858161462484006514, 168870288186037165317237437722657252078900747583218061139236575915, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);

        invariant_collateral_CT1_CT7();
    }

    function test_regression_10_buckets_exchange_rate() external {
        _basicERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 26963870279491362, 3601254755561650650360315550225832165809937215074736, 3);
        _basicERC20PoolHandler.pledgeCollateral(1, 40937702662375620098041553673274794675563238421444364181, 1806299292781392482814941608217714);
        _basicERC20PoolHandler.transferLps(115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 26);
        _basicERC20PoolHandler.addQuoteToken(9086412395094638972007390189682, 8017988708875371050349109733764, 266534290007540556135436437121220, 787972529567086468575527683806);
        _basicERC20PoolHandler.drawDebt(3, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.repayDebt(607418644361740467859860, 3596613749317836791599288999578, 126973386001551158);
        _basicERC20PoolHandler.addCollateral(17961069541001395512, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 81216080311786972267543281713646, 36083189127252982075046);
        _basicERC20PoolHandler.repayDebt(879265086388357000017570476021613397720047, 1, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.addQuoteToken(2074760358537425509206115888966642, 1000052509226306402, 1000216183594279728, 3626850572378510482520934156110);
        _basicERC20PoolHandler.addQuoteToken(7237766368913837526279800803850926, 2318473227034367386476981536426, 3397753274562712559962219817121, 3497677980587);
        _basicERC20PoolHandler.removeCollateral(2, 1, 22225753124285528776218150577139424248166623103654, 2);

        invariant_exchange_rate();
    }

    function test_regression_10_buckets_exchange_rate_2() external {
        _basicERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 17818855137382186474378203925478798087362081064669755109660);
        _basicERC20PoolHandler.addCollateral(964764110637273391149124793103, 936928192160217426868916642063, 12955560945978902771121849, 2701606087371011725063830630393);
        _basicERC20PoolHandler.removeCollateral(1000233017073419014, 493168574173516667837628028479, 1000343878875971862, 1000456862367981607271282879183);
        _basicERC20PoolHandler.removeCollateral(688160553555940795759938325497944173800517078344861811099552611334630134, 5520300724063246494671071725488, 3164757341640618278, 2566067341560472579524138938086);
        _basicERC20PoolHandler.removeQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 41316723850064749855432968190893852, 1704156508, 1);
        _basicERC20PoolHandler.moveQuoteToken(2338402619729444670366505962819150530378316367411261236887124071421, 1002224041809029153, 2834327347641428773029188, 1000413425240358656, 746591544249884746466149963933);
        _basicERC20PoolHandler.removeCollateral(1388044745591696560869746190501689966701146364533, 1444911079603055211427832649212708779095906518345500, 146224647513095394826, 115792089237316195423570985008687907853269984665640564039457584007913129639933);
        _basicERC20PoolHandler.removeQuoteToken(3, 0, 14682057797145934596306613629765202023028155589188791234994295689059743703775, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _basicERC20PoolHandler.addCollateral(1573875203397848960670186019073248854602426094673, 2504217569840181286227620309719896586961536673187089015258250231162, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 2);
        _basicERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 25673965657298153291575883442400894202624273572440854514727495, 1606415152236964885598131062907211614020217776051558);

        invariant_exchange_rate();
    }

    function test_regression_10_buckets_F4() external {
        _basicERC20PoolHandler.moveQuoteToken(13234449535566095703531866953212457366696209938115942596093570715251, 60374778675415672380560, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 3, 171308252132017301932164837198243853648547295794439243930145939017);
        _basicERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639935, 6335515217046864691, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _basicERC20PoolHandler.pledgeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639933);
        _basicERC20PoolHandler.addCollateral(6296421660734538372623618614208786496541, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0, 1);
        _basicERC20PoolHandler.addCollateral(4518678283152371114, 2, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 102774731127178500371069294026531481660623908768344624881339468320844617);
        _basicERC20PoolHandler.pledgeCollateral(787973584684501059282315698711, 2920151741518916367111665950222, 123224745043874830703997919895);
        _basicERC20PoolHandler.pullCollateral(1573681034138562592148446961981, 5395039744831658857563353458119, 999999999999999999976489190096550336802923519);
        _basicERC20PoolHandler.drawDebt(6394102097403381167740208256634, 1000018554440804369, 8672057495977214373296863722573852739162441602919679032972630);
        _basicERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639935, 140881254558364192728545623, 613322747455025846625942820);
        _basicERC20PoolHandler.drawDebt(714318606031963959460439666, 3840097364686600160570735710605, 1619253008376079830967680273);
        _basicERC20PoolHandler.repayDebt(1673798751, 5694842710945459528642451559494, 283670364632203665819796449);
        _basicERC20PoolHandler.pullCollateral(6440809887369074468946703546240400837213546534, 2703097808456042804242921317, 1280483304446323279875015625413976687208364448);
        _basicERC20PoolHandler.moveQuoteToken(2645907677966809348905615900887, 1000290596345984668, 8911595135731625941490882255952, 1000114004480165314, 999999999999999492047613175637745184412049525);
        _basicERC20PoolHandler.moveQuoteToken(17910056905799029767578947, 1864370690112038787667315417001207317411, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 2, 749884739185720130);
        _basicERC20PoolHandler.pledgeCollateral(0, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 2);
        _basicERC20PoolHandler.removeCollateral(29916223351185949468184326014674437876671, 4589, 52359455270961644929860673030618666251977951329658, 107072856710625989514364630708);
        _basicERC20PoolHandler.addQuoteToken(4993846574496845238683822200553772267301, 183, 29385267992611576362491572129746482837, 565);
        _basicERC20PoolHandler.addQuoteToken(1000000587241149501, 4116061719989634076062029107625, 6527585355223355420736028299386, 1000911055401543919);
        _basicERC20PoolHandler.transferLps(115792089237316195423570985008687907853269984665640564039457584007913129639934, 1470588913202219277134099465404333890924499099636114330, 573574378967188764061305709654269675491379293416, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.addQuoteToken(6140956152846499655446977014073860862591380590488851, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 51907021185997214374267034487848418094701660362324021482169247216619633872456);
        _basicERC20PoolHandler.transferLps(261107, 7446853454023879126467395434433, 506895469181496737976330135, 7619952985071068405252281695334, 6154220663342048290252790511294);
        _basicERC20PoolHandler.drawDebt(688145878123546326583851366405289536070038389815044157043873133851063296, 7068007098627274874879419480, 7572765270442657913100320178565);
        _basicERC20PoolHandler.addCollateral(132849244362624672017210770, 160220481144050675301217580027770099132176677062347807, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 3);
        _basicERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639935, 4635788663783749582745368569664957810107889387318368328644395925, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 118711021541658804984564302878252);
        _basicERC20PoolHandler.removeQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639932, 0, 8445096883336947366831914851854070736188169226787134562965608120754828249, 31702553921285986);
        _basicERC20PoolHandler.addCollateral(580611839910456831033498928563420669329295299872174796, 365592807736295354208641933456297478927564166157028915669712361006111378, 28139754781488792473550239412555, 16783034798732718173574507487472772049042281150918117690);
        _basicERC20PoolHandler.removeQuoteToken(3894404124500698217057152848884, 27478283841917457404525494988, 3021754851825746291696621607292, 1000001004962305311928772643717);
        _basicERC20PoolHandler.addQuoteToken(468, 2, 43724, 1152399744924008194743423951);
        _basicERC20PoolHandler.repayDebt(796770899347121193810335509368635, 788797746707273155957044869328, 325418985476243884442958426017);
        _basicERC20PoolHandler.moveQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 7422932955149615012023501180176513465114, 1, 115792089237316195423570985008687907853269984665640564039457584007913129639933);
        _basicERC20PoolHandler.moveQuoteToken(11029268151348809599542295670992, 1674842588, 8836271060776756896119326907222, 688281732625303322675897722815970653485080269470846731021832930365693760, 535384403053933584684655656);
        _basicERC20PoolHandler.pledgeCollateral(1574478871504291917188801399286, 4544847225095148439060231333417, 130666618043756744430885952105154);
        _basicERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639935, 342447337001, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _basicERC20PoolHandler.transferLps(2, 0, 855521114601779757043497214366146208917380641227576, 6763612574518268953226767616, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _basicERC20PoolHandler.removeQuoteToken(4611889325915228483301526481319615, 38084, 42580832955904510762171045873877, 2636152856526958443712217183212702);
        _basicERC20PoolHandler.removeQuoteToken(29970599961641859108393123641560445894663409577582723877517332108011544504464, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 135, 13893178818345121509111186504303183497844);
        _basicERC20PoolHandler.pullCollateral(5769192817483987112721415532428, 16259463482118041401855347103, 1543735509442123611738770410327);
        _basicERC20PoolHandler.removeQuoteToken(1628467737203148079868996591494, 447404570018145143444980749, 4762130513423858141603250586289, 1885022364152755698804721861718);
        _basicERC20PoolHandler.addQuoteToken(0, 1, 69913830042719777813687647207537411321915157217229742561136685684500709, 3);
        _basicERC20PoolHandler.removeQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639935, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 1);
        _basicERC20PoolHandler.pledgeCollateral(536503026894930742915592263726, 5958204048624414206720153263482, 981672851175865744292519803023);

        invariant_fenwick();
    }
}

