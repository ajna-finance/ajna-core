// SPDX-License-Identifier: UNLICENSED

pragma solidity 0.8.14;

import { ReserveERC20PoolInvariants } from "../../invariants/ERC20Pool/ReserveERC20PoolInvariants.t.sol";

contract RegressionTestReserveERC20Pool is ReserveERC20PoolInvariants { 

    function setUp() public override {
        // failures reproduced with 3 active buckets
        vm.setEnv("NO_OF_BUCKETS", "3");
        super.setUp();
    }   

    function test_regression_reserve_1() external {
        _reserveERC20PoolHandler.kickAuction(3833, 15167, 15812, 0);
        _reserveERC20PoolHandler.removeQuoteToken(3841, 5339, 3672, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    // test was failing due to error in local fenwickAccureInterest method
    function test_regression_reserve_2() external {
        _reserveERC20PoolHandler.bucketTake(19730, 10740, false, 15745, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
        _reserveERC20PoolHandler.addCollateral(14982, 18415, 2079, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_3() external {
        _reserveERC20PoolHandler.repayDebt(404759030515771436961484, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
        _reserveERC20PoolHandler.removeQuoteToken(1, 48462143332689486187207611220503504, 3016379223696706064676286307759709760607418884028758142005949880337746, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_4() external {
        _reserveERC20PoolHandler.takeAuction(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 1, 0);  

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_5() external {
        _reserveERC20PoolHandler.addQuoteToken(16175599156223678030374425049208907710, 7790130564765920091364739351727, 3, 0);
        _reserveERC20PoolHandler.takeReserves(5189, 15843, 0);
        _reserveERC20PoolHandler.bucketTake(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639933, false, 32141946615464, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_6() external {
        _reserveERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.removeQuoteToken(3, 76598848420614737624527356706527, 0, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_7() external {
        _reserveERC20PoolHandler.addQuoteToken(3457, 669447918254181815570046125126321316, 999999999837564549363536522206516458546098684, 0);
        _reserveERC20PoolHandler.takeReserves(0, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.takeAuction(1340780, 50855928079819281347583122859151761721081932621621575848930363902528865907253, 1955849966715168052511460257792969975295827229642304100359774335664, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_8() external {
        _reserveERC20PoolHandler.addQuoteToken(0, 16517235514828622102184417372650002297563613398679232953, 3, 0);
        _reserveERC20PoolHandler.takeReserves(1, 824651, 0);
        _reserveERC20PoolHandler.kickAuction(353274873012743605831170677893, 0, 297442424590491337560428021161844134441441035247561757, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_9() external {
        _reserveERC20PoolHandler.addQuoteToken(8167, 13910, 6572, 0);
        _reserveERC20PoolHandler.removeQuoteToken(450224344766393467188006446127940623592343232978, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 3, 0);
        _reserveERC20PoolHandler.addQuoteToken(1338758958425242459263005073411197235389119160018038412507867175716953081924, 0, 3, 0);
        _reserveERC20PoolHandler.removeQuoteToken(13684, 7152374202712184607581797, 37874588407625287908455929174, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_10() external {
        _reserveERC20PoolHandler.drawDebt(3, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.takeAuction(57952503477150200455919212210202824, 59396836510148646246120666527, 253313800651499290076173012431766464943796699909751081638812681630219, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_11() external {
        _reserveERC20PoolHandler.drawDebt(121976811044722028186086534321386307, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);
        _reserveERC20PoolHandler.removeQuoteToken(22099, 75368688232971077945057, 1089607217901154741924938851595, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_12() external {
        _reserveERC20PoolHandler.drawDebt(7201, 13634, 0);
        _reserveERC20PoolHandler.kickReserveAuction(4584, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_13() external {
        _reserveERC20PoolHandler.kickAuction(115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 540213858694280098848655811354140073005, 0);
        _reserveERC20PoolHandler.takeAuction(0, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 16744276840254269931315148200783781329474, 0);
        _reserveERC20PoolHandler.settleAuction(1052055081946638635908683442568, 2, 3, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_14() external {
        _reserveERC20PoolHandler.settleAuction(437841947740231831335707997666789355668988087441752683415964733126988332082, 147808166723925302409649247274, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    /*
        Test was reverting when kicker and taker are same and kicker is penalized while taker is getting lps.
        Fixed by separating kicker and taker condition in 'bucketTake' handler
    */
    function test_regression_reserve_15() external {
        _reserveERC20PoolHandler.settleAuction(412239579320, 197270, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.bucketTake(2751494394076294863634, 102579647081354295527475262786, false, 20636732314060673687564, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_reserve_16() external {
        _reserveERC20PoolHandler.kickWithDeposit(24364934041550678417946191455, 52607039466540426076659653665991, 0);
        _reserveERC20PoolHandler.moveQuoteToken(12701858085177571414571267592, 42692775850651681314985098497603, 999999999999999997089137720115121650200233243, 110756792431977317946585133, 0);
        _reserveERC20PoolHandler.takeReserves(1000000005297961791, 4169814726576748738687746199368099036929520400874217254297794929654231, 0);
        _reserveERC20PoolHandler.takeReserves(3052809529665022333893308239466671666604242469878272137069, 2, 0);
        _reserveERC20PoolHandler.settleAuction(56829802927206056542134152487104, 1, 16551256, 0);
        _reserveERC20PoolHandler.bucketTake(115792089237316195423570985008687907853269984665640564039457584007913129639932, 4559892907266199616760, true, 92132592320410512639572628067656882480659844625060229234412683145, 0);
        _reserveERC20PoolHandler.addQuoteToken(26659, 27252796304289191617124780530313880584663397025838797405583704016009646047240, 8174069071114126926049883726727, 0);
        _reserveERC20PoolHandler.settleAuction(7416752279321695807446009676282848840713503167567654621163487831711306738, 42429259698839522507819580090756, 4353185348715295869540288672, 0);
        _reserveERC20PoolHandler.bucketTake(115792089237316195423570985008687907853269984665640564039457584007913129639932, 1, true, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.takeReserves(7414584624540108578389380660398591567646816233407392320795021351932076518, 119186585263660671065239170291646549528129172578, 0);
        _reserveERC20PoolHandler.takeReserves(14604452466686952199052773378, 15308, 0);
        _reserveERC20PoolHandler.moveQuoteToken(2, 7113439765, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 101839127799233627783, 0);
        _reserveERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, 0);
        _reserveERC20PoolHandler.removeQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639935, 175006273713916823228319530732179, 3, 0);
        _reserveERC20PoolHandler.kickAuction(999999999999999989948035804259829580593704779, 2999999999999999995605838724439103323477035837, 567178035339127142779327214, 0);
        _reserveERC20PoolHandler.kickWithDeposit(17028734043909648834002499445, 9578925065330517200577552073309, 0);
        _reserveERC20PoolHandler.addQuoteToken(6672165, 3776221923932077947607417775990788567, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_fenwick_deposits_1() external {
        _reserveERC20PoolHandler.pledgeCollateral(2, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.takeAuction(2, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 22181751645253101881254616597347234807617, 0);

        invariant_fenwick_depositAtIndex_F1();
        invariant_fenwick_depositsTillIndex_F2();
    }

    function test_regression_incorrect_zero_deposit_buckets_1() external {
        _reserveERC20PoolHandler.addQuoteToken(26716, 792071517553389595371632366275, 1999999999999999449873579333598595527312558403, 0);

        invariant_fenwick_prefixSumIndex_F4();
        _reserveERC20PoolHandler.takeAuction(3383098792294835418337099631478603398072656037191240558595006969488860, 23280466048203500609787983860018797249195596837096487660362732305, 999999999999999999999999012359, 0);

        invariant_fenwick_prefixSumIndex_F4();
    }

    function test_regression_incorrect_zero_deposit_buckets_2() external {
        _reserveERC20PoolHandler.addCollateral(9093188371345232280759885514931620, 736370925, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.removeQuoteToken(2, 743823342719479363729966668312423206558602, 6003791801508574660825548152233943700089469549364090309, 0);
        _reserveERC20PoolHandler.removeQuoteToken(261467129238591107899210386032213509797152237956889, 1034, 48028560549472995, 0);
        _reserveERC20PoolHandler.addQuoteToken(261467129238591107899210386032213509797152237956889, 1034, 48028560549472995, 0);
        _reserveERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.addQuoteToken(22558, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 26798251134, 0);
        _reserveERC20PoolHandler.moveQuoteToken(699684583201376669946795465695023954383, 871337618071093223322748209250657757655686665685488924893819949988, 6856667370119202181100844692321254723509125063768335, 2, 0);
        
        invariant_fenwick_prefixSumIndex_F4();

    }

    function test_regression_incorrect_bond() external {
        _reserveERC20PoolHandler.settleAuction(18129, 6125, 756, 0);

        invariant_bond_A2();
        invariant_fenwick_depositAtIndex_F1();
    }

    function test_regression_invariant_reserves_fenwick_depositAtIndex_F1() external {
        _reserveERC20PoolHandler.kickAuction(14062, 13380, 20332, 0);
        _reserveERC20PoolHandler.kickAuction(115792089237316195423570985008687907853269984665640564039457584007913129639933, 2, 250713412144308447525906089113510093407014793436690623, 0);
        _reserveERC20PoolHandler.bucketTake(2, 115792089237316195423570985008687907853269984665640564039457584007913129639933, true, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);

        invariant_fenwick_depositAtIndex_F1();
    }

    function test_regression_invariant_reserves_settle_1() external {
        _reserveERC20PoolHandler.settleAuction(2999999999999999543503680529282898884169444286, 999999999999999999999999, 6952, 0);
        _reserveERC20PoolHandler.bucketTake(115792089237316195423570985008687907853269984665640564039457584007913129639932, 0, false, 228076556654255348886, 0);
        _reserveERC20PoolHandler.kickReserveAuction(18407833277983020451007887294192863287187933, 0);
        _reserveERC20PoolHandler.settleAuction(2720, 3319, 516, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_invariant_reserves_settle_2() external {
        _reserveERC20PoolHandler.takeAuction(3, 214198155653990209702223102757081411626927025, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.repayDebt(36, 19087, 0);
        _reserveERC20PoolHandler.drawDebt(2550145944163683156825587547113715005197220288637184, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_invariant_reserves_invariant_quoteTokenBalance_QT1_1() external {
        _reserveERC20PoolHandler.kickAuction(22771, 1111716442170237736883602263032, 7068, 0);
        _reserveERC20PoolHandler.addCollateral(450013003559446434159001584489461823249847174057443177111241841181931, 312804075096415570730723645176181753809227168111076176815108, 0, 0);
        _reserveERC20PoolHandler.pledgeCollateral(1985831902099838153679635097394320832859625435, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.settleAuction(115792089237316195423570985008687907853269984665640564039457584007913129639933, 2, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.transferLps(1, 11785568695658463091194696857966812287312218400594, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0, 0);
        _reserveERC20PoolHandler.takeAuction(159178586166894, 2, 2, 0);
        _reserveERC20PoolHandler.kickAuction(2, 2375789919282905103386504516485994899, 1289653, 0);
        _reserveERC20PoolHandler.kickReserveAuction(2162, 0);
        _reserveERC20PoolHandler.settleAuction(4612, 40708630701038224142448353799854069842509049093396550723073072047814079, 39027373949250548040512012762457247677933424051240699689883568078322057459524, 0);
        _reserveERC20PoolHandler.settleAuction(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 1, 0);

        invariant_quoteTokenBalance_QT1();
    }

    function test_regression_invariant_reserves_invariant_quoteTokenBalance_QT1_2() external {
        _reserveERC20PoolHandler.drawDebt(1, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);
        _reserveERC20PoolHandler.pullCollateral(8213783947977569843117913236674123519747026, 26007879196259510050186964175498569516185804333067186877, 0);
        _reserveERC20PoolHandler.drawDebt(2301679051848045604, 2599238865, 0);
        _reserveERC20PoolHandler.addCollateral(4242066606167690018840733069974159, 2308657525655903223461843364795, 65478701235782653506998474972558, 0);
        _reserveERC20PoolHandler.kickAuction(69087967303211947138147234149237227681311399268590256122007, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 61509477439, 0);
        _reserveERC20PoolHandler.bucketTake(72107205250762587233492136850, 1244277915808615586782916545843, false, 39013151190969055659579687996, 0);
        _reserveERC20PoolHandler.transferLps(235427298074932216827475360756961, 2730975142229662626738653393718571, 1801094436838792863068211758488417, 879376648610435813515943108046, 0);
        _reserveERC20PoolHandler.bucketTake(740590071845914415309602438961, 903524249678397461462482055179, false, 999387178588229710810342952208, 0);
        _reserveERC20PoolHandler.settleAuction(1996, 648686406391068869253434465091, 1012371126513011680823527365765, 0);
        _reserveERC20PoolHandler.kickAuction(2758621226294910077454620848, 1587186203667651966808515455274, 999999999999999766114657929326397241693634383, 0);
        _reserveERC20PoolHandler.kickReserveAuction(115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.addCollateral(860262795452324500467615408841617417042130132486395050948571309437624254, 88294053979131610681224002926017918012056109605052596771915843, 2509079085932223405093441153560904865353589, 0);
        _reserveERC20PoolHandler.drawDebt(3, 2, 0);
        _reserveERC20PoolHandler.bucketTake(1112272948946288199596319174059, 651469309530642638235774421, false, 2631651594321033821284801688396855, 0);
        _reserveERC20PoolHandler.pullCollateral(1, 104099149887771887762252474591136544290691758, 0);
        _reserveERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 3893316282729587584044696989905829964749218951828499823513945610388772348, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639933, 1079490131956486279124163833769398638737841713956621, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);
        _reserveERC20PoolHandler.kickReserveAuction(0, 0);
        _reserveERC20PoolHandler.settleAuction(1685708597792729438175883702650, 2952680495818774014078, 5097264761526793300787284458, 0);

        invariant_quoteTokenBalance_QT1();
    }

    function test_regression_invariant_reserves_invariant_quoteTokenBalance_QT1_3() external {
        _reserveERC20PoolHandler.addQuoteToken(2, 2, 306147942052277777154794038508061442, 0);
        _reserveERC20PoolHandler.takeReserves(999999997592778230040335721194842507878613188, 617767166532412476599141189, 0);
        _reserveERC20PoolHandler.kickReserveAuction(103210968180742388081044815736108888392928341723424194324988612249639, 0);
        _reserveERC20PoolHandler.kickWithDeposit(571331675273077569870268525690, 3000000000000000153070529032047742375224439804, 0);
        _reserveERC20PoolHandler.transferLps(115792089237316195423570985008687907853269984665640564039457584007913129639935, 1, 2345974107770202992, 596944268880651135381308885897365469741047535828013376978854456255492067, 0);
        _reserveERC20PoolHandler.kickAuction(249542131817080594576330466916380605939068941221926774088755, 1792443579171442237436215, 2, 0);
        _reserveERC20PoolHandler.settleAuction(2475430586786710276861336070835, 2600907908657087816392951766665339, 618867463233346276220185869, 0);
        _reserveERC20PoolHandler.bucketTake(288221154502730111886403777699180, 4013402100758707152779826705918182, false, 3000000000000000997154081605746206372402043417, 0);
        _reserveERC20PoolHandler.addQuoteToken(9798212016992127202141315997364967680599055895, 3, 1072606682991056733959287049686598376179068454808322552897362615, 0);
        _reserveERC20PoolHandler.pledgeCollateral(153445992298474361671974195535972272220394541157224893523804178985601, 53709221935782524388066885085801417, 0);
        _reserveERC20PoolHandler.kickReserveAuction(1, 0);
        _reserveERC20PoolHandler.bucketTake(3, 1, true, 2, 0);
        _reserveERC20PoolHandler.settleAuction(2518428390102925899809538437634001, 351638851502181329392182678513150532940060325784767627878107695205, 3071611172974674710789364893, 0);
        _reserveERC20PoolHandler.transferLps(28822226972612722036870301886639533933908463827921999334463168, 1, 314514798153750347019311, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);
        _reserveERC20PoolHandler.pullCollateral(2, 2, 0);
        _reserveERC20PoolHandler.settleAuction(115792089237316195423570985008687907853269984665640564039457584007913129639932, 60110048782249025340, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);

        invariant_quoteTokenBalance_QT1();
    }

    function test_regression_invariant_reserves_invariant_quoteTokenBalance_QT1_4() external {
        _reserveERC20PoolHandler.takeAuction(115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.repayDebt(123785744463475277851, 431477, 0);
        _reserveERC20PoolHandler.transferLps(8349868629210939854344368826901611192, 2050523511941068426657597285533, 482178822629563486190079445656644, 113294184847064316812952522804, 0);
        _reserveERC20PoolHandler.kickWithDeposit(115792089237316195423570985008687907853269984665640564039457584007913129639934, 1, 0);
        _reserveERC20PoolHandler.settleAuction(2, 60232917818899277216367937385395389606, 109871490879953029603376159938904259489696033217506136, 0);
        _reserveERC20PoolHandler.repayDebt(11000946587948121111587595267746251370302202324589596297423219199459160, 1640564753028103680512592653747, 0);
        _reserveERC20PoolHandler.kickAuction(3981871706795545560915874060150150667177950440617972926122855684987, 198277768150818655020367, 2892877132676919180494078569276042, 0);
        _reserveERC20PoolHandler.addCollateral(1263277608, 63278488014355910828533249093658068159654702008400, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.pullCollateral(2673207612857671157084473752324442, 2000121050152966887141053752381, 0);
        _reserveERC20PoolHandler.removeCollateral(17512256671104333742254942029, 940622488995047370832475, 17490, 0);
        _reserveERC20PoolHandler.takeReserves(4664936529054748613171449032640911546982046023628226142220220474, 12228144613454452340256380805978754348438442703119, 0);

        invariant_quoteTokenBalance_QT1();
    }

    function test_regression_invariant_reserves_invariant_quoteTokenBalance_QT1_5() external {
        _reserveERC20PoolHandler.settleAuction(841361270493647884419014561906636, 98291268956781519518581599501066994252857442823583923678216713962377882453983, 1406581758883, 0);
        _reserveERC20PoolHandler.takeAuction(1383411077269858329680139336144799098803584219410295488, 3, 0, 0);
        _reserveERC20PoolHandler.repayDebt(46968019084877, 3, 0);
        _reserveERC20PoolHandler.settleAuction(40124885934647691486197516987534429290957609634434455185985854549948025389553, 7413335529509918122196253760378, 3, 0);
        skip(2 hours);
        _pool.updateInterest();
        currentTimestamp = block.timestamp;
        invariant_quoteTokenBalance_QT1();
    }

    function test_regression_invariant_reserves_settle_3() external {
        _reserveERC20PoolHandler.bucketTake(38522325070060518315904717784000000000, 74804166371079302281493396778, false, 243284095655821418741726406906, 0);
        _reserveERC20PoolHandler.removeQuoteToken(63300517263709739718213296806, 544282601310994378458621785271097, 93004761485750531023207874, 0);
        _reserveERC20PoolHandler.kickAuction(115792089237316195423570985008687907853269984665640564039457584007913129639934, 10850580031398165201080403693039642, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);
        _reserveERC20PoolHandler.takeAuction(1006654503300439100037731502194, 999999999999999820916638470184939411687495097, 2999999999999999849116243910762621146260836956, 0);
        _reserveERC20PoolHandler.settleAuction(513358560825207984200760701, 527826952804937875408570995575150, 3075, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_invariant_reserves_settle_4() external {
        _reserveERC20PoolHandler.kickAuction(999999999999999886611844846637902655009191722, 809319421722186623206028334686443, 33424777291596678039713, 0);
        _reserveERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, 2503088493515274266, 0);
        _reserveERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639934, 16755, 0);
        _reserveERC20PoolHandler.removeQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639932, 1, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.settleAuction(3, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 2, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_invariant_take_reserves_1() external {
        _reserveERC20PoolHandler.drawDebt(3, 2472487412192096145519673462983934503, 0);
        _reserveERC20PoolHandler.takeReserves(115792089237316195423570985008687907853269984665640564039457584007913129639933, 50482403089838632034016548451617756782, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_invariant_take_reserves_2() external {
        _reserveERC20PoolHandler.kickAuction(2, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.takeReserves(9990, 2, 0);
        _reserveERC20PoolHandler.takeAuction(2, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 32167191465467724730024789812, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_invariant_take_reserves_3() external {
        _reserveERC20PoolHandler.kickAuction(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 7863893832813740178393566165935290555711, 0);
        _reserveERC20PoolHandler.takeAuction(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 672940003103495713632014456312899612181893075117989217767500902, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }

    function test_regression_invariant_take_reserves_4() external {
        _reserveERC20PoolHandler.bucketTake(0, 115792089237316195423570985008687907853269984665640564039457584007913129639934, true, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.takeReserves(2000008144440715646777241504589, 695559613732339828463793224249, 0);
        _reserveERC20PoolHandler.takeAuction(5260, 3000000000000000000000010654836333921317470662, 6571232818648673809695471386, 0);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }
    
    function test_regression_invariant_repayDebt_F2_1() external {
        _reserveERC20PoolHandler.takeAuction(1, 955139331336232548042968484715961932654029262247576677099836, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.addQuoteToken(19874832899, 2, 19674101910639560463031669634628955697045, 0);
        _reserveERC20PoolHandler.kickAuction(1000000000372489032271805343253, 33527, 2999999999999998999627510967728193679786334003, 0);
        _reserveERC20PoolHandler.takeAuction(30442763437987671335943625876181535412080651070033770037765737902267600059, 0, 62793434148368637031717982910725, 0);
        _reserveERC20PoolHandler.drawDebt(1, 2, 0);
        _reserveERC20PoolHandler.takeAuction(28478785935025462058931686388528614452411453327852591879599088, 1426479312070353, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.drawDebt(10933, 2937, 0);
        _reserveERC20PoolHandler.takeAuction(115792089237316195423570985008687907853269984665640564039457584007913129639935, 2, 6122968755523040, 0);
        _reserveERC20PoolHandler.repayDebt(10917282482493108186780095138347753666882231491750232316870663654516774564, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);

        invariant_fenwick_depositsTillIndex_F2();
    }

    function test_regression_invariant_takeAuction_F3() external {
        _reserveERC20PoolHandler.drawDebt(66012189296213, 3501011380219996136241089195497, 0);
        _reserveERC20PoolHandler.kickAuction(5022297903775350684886398975, 20526, 2902853749630275072725962069, 0);
        _reserveERC20PoolHandler.bucketTake(115792089237316195423570985008687907853269984665640564039457584007913129639932, 1, true, 4391496802861267555764811220, 0);
        _reserveERC20PoolHandler.moveQuoteToken(26018560, 3192, 25995484456155391449642016017, 22537, 0);
        _reserveERC20PoolHandler.transferLps(10763986310328530217005920827655704540417291683469924162879658, 4634, 8842, 3, 0);
        _reserveERC20PoolHandler.settleAuction(2913861884801667469428509650, 17685440748964982730500143988068465999241920952718023027278539889735696458314, 744860398079104642573120377479575543713282684535849403581932752660396046, 0);
        _reserveERC20PoolHandler.takeReserves(9546428924610247071820016, 1, 0);
        _reserveERC20PoolHandler.kickAuction(1021712469506287128291988, 470273052888220, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.kickWithDeposit(21372131561480654576901520848, 583255095299263976575486908, 0);
        _reserveERC20PoolHandler.kickAuction(115792089237316195423570985008687907853269984665640564039457584007913129639933, 219682941, 6398456408984021365251851328837461998816613070677747503909692892499751257833, 0);
        _reserveERC20PoolHandler.moveQuoteToken(8413969458442105899430554342773, 42973831423907508485458560352, 14483994975746621772566970294, 27693669185946254354714892761, 0);
        _reserveERC20PoolHandler.bucketTake(0, 1, false, 1, 0);
        _reserveERC20PoolHandler.takeAuction(2760306433008897416497, 35178760526536102733112750779, 307455027758822287663945712, 0);

        invariant_fenwick_bucket_index_F3();
        invariant_fenwick_prefixSumIndex_F4();
    }

    function test_regression_kick_F1_F2() external {
        _reserveERC20PoolHandler.bucketTake(115792089237316195423570985008687907853269984665640564039457584007913129639932, 1513638311409397559820116, false, 1107177539379, 0);
        _reserveERC20PoolHandler.removeQuoteToken(11979868839631132246101, 1137392, 2, 0);
        _reserveERC20PoolHandler.takeReserves(3, 398628895133942030524702233785087782308780160336206641843430908, 0);
        _reserveERC20PoolHandler.takeAuction(296258719633565160185329, 490859840095298219320862, 16604700944401714968833692676, 0);
        _reserveERC20PoolHandler.kickAuction(1007024558278734662013991074770, 12316238, 8522190612260582802728723964891359810344750053801981528212387048, 0);
        _reserveERC20PoolHandler.takeAuction(999999999999999990212662818220103017885508577, 13644265990130681739980240101, 365402912996683431395427167362586262781607554542513822722975820380813222232, 0);
        _reserveERC20PoolHandler.takeAuction(999999999999999990000000000000000000000993018, 31506548945590221240114018464, 1016963456957222995035464545, 0);
        _reserveERC20PoolHandler.bucketTake(115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, false, 30294494991681513847857232418933803770638682537, 0);
        _reserveERC20PoolHandler.kickAuction(2324631542950979206383056100280239271207523734887421, 1, 23494016960770235530146856844201861803189848725938507629, 0);

        invariant_fenwick_depositAtIndex_F1();
        invariant_fenwick_depositsTillIndex_F2();
    }

    function test_regression_remove_R1() external {
        _reserveERC20PoolHandler.takeAuction(1000000000147122258, 3919731510820678131056801, 158441107709132461742605107, 0);
        _reserveERC20PoolHandler.repayDebt(15097247704276523502490912, 5821681489746654725611665637, 0);
        _reserveERC20PoolHandler.addQuoteToken(409278183265946161107935122, 13459778251101474251175765782, 17131651646875762675637482511491680925564181440856864512, 0);
        _reserveERC20PoolHandler.kickWithDeposit(3000000000000000000003060052276861736589117902, 10971651541557993591476169, 0);
        _reserveERC20PoolHandler.drawDebt(99176811231448450752542388131222351, 4756085816094695387473840, 0);
        _reserveERC20PoolHandler.transferLps(345464481275697722, 1, 1571, 636770839146216364947817981246144824780203402016795537219680499840300283500, 0);
        _reserveERC20PoolHandler.takeReserves(1, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.removeQuoteToken(2921676640197348125883567882, 110429299813004951706741973, 5838113258459267571531065497, 0);

        invariant_exchangeRate_R1_R2_R3_R4_R5_R6_R7_R8();
    }

    function test_regression_exrate_accuracy_R1() external {
        _reserveERC20PoolHandler.moveQuoteToken(0, 1095007911, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 10069220832808935, 0);
        _reserveERC20PoolHandler.kickAuction(2235318869033878164575850860, 25288937613311342943333937133, 83682862171707962382757764951, 0);
        _reserveERC20PoolHandler.addQuoteToken(3, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 2732924787785177969603119436532655486434403999080563574919756204077541, 0);
        _reserveERC20PoolHandler.kickAuction(2970471299408419676825342051, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 1, 0);
        _reserveERC20PoolHandler.bucketTake(0, 11522913996, true, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        invariant_exchangeRate_R1_R2_R3_R4_R5_R6_R7_R8();
    }

    /* 
        Test was reverting when movedQuoteToken > amountPassed, this happens in case when buckets gets empty.
        Fixed by adding check in increaseInReserve calculation in 'moveQuoteToken' handler
    */
    function test_regression_evm_revert_1() external {
        _reserveERC20PoolHandler.takeAuction(2520000968586068692750846759781727871330432521653849554728884, 842011260485420553676704792240552622539346320776828594643332095169708168242, 8055807, 0);
        _reserveERC20PoolHandler.moveQuoteToken(1, 231772084031809103573597600784780758697344200147089918620804085, 2, 664746035165900383390596853874831864040676775434826512224949736661840288899, 0);
        _reserveERC20PoolHandler.removeCollateral(1208370290348562883186186, 1, 1, 0);
        _reserveERC20PoolHandler.takeAuction(5259923301902342744141092410691697923135981, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, 0);
        _reserveERC20PoolHandler.moveQuoteToken(8974296309703512994561526975050221771958436087084360221, 0, 12487898, 0, 0);
    }

    /*  
        Test was reverting when redeemedLps = bucketLps but lenderlps < redeemedLps, this happens due to slight rounding error in deposit calculation from lps
        Fixed by updating redeemedLP calculations to `vars.redeemedLP = Maths.min(lender.lps, vars.redeemedLP)`
    */
    function test_regression_evm_revert_2() external {
        _reserveERC20PoolHandler.moveQuoteToken(1, 2, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 158129467307529830729349478455, 0);
        _reserveERC20PoolHandler.removeQuoteToken(2999999999999999484865294266928579000517539849, 20462, 1576762402919713971836094859031, 0);
        _reserveERC20PoolHandler.takeReserves(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.settleAuction(115792089237316195423570985008687907853269984665640564039457584007913129639933, 54458727957125675340786496871311264885201, 3, 0);
        _reserveERC20PoolHandler.drawDebt(3, 105, 0);
        _reserveERC20PoolHandler.moveQuoteToken(6852481993231188391093194134731580567074964777826972502281, 329445, 0, 0, 0);
        _reserveERC20PoolHandler.transferLps(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 3, 7021699771963113994546981195098591531040470835170729980, 0);
        _reserveERC20PoolHandler.kickAuction(222097115856593934764213313250516314101951310591954099083410060419874648, 2249513945015671956, 607419547883141581230100154864, 0);
        _reserveERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 900686135540961542876969152475416605137543635582763473, 0);
        _reserveERC20PoolHandler.kickReserveAuction(0, 0);
        _reserveERC20PoolHandler.kickReserveAuction(115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);
        _reserveERC20PoolHandler.repayDebt(115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, 0);
        _reserveERC20PoolHandler.addCollateral(942680573168415959, 1199548961510475789275654540025108262785374840317057516601691579134979, 2999999999999999999695465971169782999351812188, 0);
        _reserveERC20PoolHandler.takeReserves(1471, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);
        _reserveERC20PoolHandler.kickReserveAuction(32594801409066350134162972068, 0);
        _reserveERC20PoolHandler.kickWithDeposit(2999999999999999574088451549152362060347655934, 48090144344287028180951883593, 0);
    }

    /*
        Test was reverting with overflow in `(tu + mau102 - 1e18) ** 2)` calculation in _calculateInterestRate
        Fixed by updating `((tu + mau102 - 1e18) ** 2) / 1e18` to `(((tu + mau102 - 1e18) / 1e9) ** 2)`
    */
    function test_regression_evm_revert_3() external {
        _reserveERC20PoolHandler.drawDebt(1000011592650618236, 427626464706163901647666438633, 0);
        _reserveERC20PoolHandler.takeReserves(115792089237316195423570985008687907853269984665640564039457584007913129639933, 1, 0);
        _reserveERC20PoolHandler.repayDebt(115792089237316195423570985008687907853269984665640564039457584007913129639934, 222282777921247831223488066461, 0);
        _reserveERC20PoolHandler.pullCollateral(15340, 22233328162, 0);
        _reserveERC20PoolHandler.bucketTake(43296517, 189401876327916916281126992296, false, 5424, 0);
        _reserveERC20PoolHandler.addCollateral(2777407746290631507500, 333697625318607566355528255834, 1000018044967910249, 0);
        _reserveERC20PoolHandler.kickReserveAuction(115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC20PoolHandler.takeReserves(90818049107020612953852548512599042076744953, 1699960882759932026837663149104517717038509322264532007389148, 0);
        _reserveERC20PoolHandler.withdrawBonds(106568634815518113798129275, 2460874687943872413578450072374086568386094010814407501, 0);
        _reserveERC20PoolHandler.addCollateral(988315461147551209368455480062, 1604895841620880925866279541638, 947957157261063855554739172111710, 0);
        _reserveERC20PoolHandler.pullCollateral(1000000000000000000000200, 9090, 0);
        _reserveERC20PoolHandler.addQuoteToken(1, 29592092711738557487974299548920457245440815108037318587348855786852817187, 835462594306266473781056, 0);
        _reserveERC20PoolHandler.takeAuction(598847416317922228449817163835395963171238146640666936329941450597, 1609410932486951851606214282597, 95354512998795826382552523444, 0);
        _reserveERC20PoolHandler.addCollateral(833040298029642855894082982789, 1076477294087, 1797816964051823308646324438005, 0);
        _reserveERC20PoolHandler.pledgeCollateral(282614408102076551687763800227, 3, 0);
        _reserveERC20PoolHandler.pullCollateral(324581451894516867771201351665741275651124, 4, 0);
        _reserveERC20PoolHandler.pledgeCollateral(3990116583418393958345352592252524240487111685089080421377559185333257001186, 63643723788868280847, 0);
        _reserveERC20PoolHandler.drawDebt(2420222920583996676329196545, 1, 0);
        _reserveERC20PoolHandler.transferLps(2999999999999999866089865785362154170272346882, 1201303985144971, 3000000000000000000069282600099281847535823208, 2516, 0);
        _reserveERC20PoolHandler.kickAuction(11585421328272707882885111971840751049901594256465502255118203311426017450, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
    }

    // Test reverting with overflow error in updateInterestState, fixed with calculating t0Debt2ToCollateral only for loans not in auction
    function test_regression_evm_revert_dwatp_calculation() external {
        _reserveERC20PoolHandler.takeAuction(50273692421744377186963564518293270398423601950557187270240, 2548824763847568430445964332385997581867729, 2, 0);
        _reserveERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639933, 2, 0);
        _reserveERC20PoolHandler.bucketTake(2, 178384181005, false, 6392753955405727164548240817297990606823468910265481812293128708, 0);
        _reserveERC20PoolHandler.removeQuoteToken(3782769546571580286491282490173426994, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 54687167, 0);
        _reserveERC20PoolHandler.settleAuction(39578, 1, 6177214753589, 0);
        _reserveERC20PoolHandler.repayDebt(1025386930210936368, 4259484542182884235320983165905627435543345198090251871456881749143615, 0);
        _reserveERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639932, 9515050199665708690603228437, 8324830839682368611784829482626590763014978434217970848520, 0);
        _reserveERC20PoolHandler.pledgeCollateral(0, 61432102823246505619, 0);
        _reserveERC20PoolHandler.kickReserveAuction(90632424972185451325878827725, 0);
        _reserveERC20PoolHandler.moveQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);
        _reserveERC20PoolHandler.removeQuoteToken(662383544472518305626297967684, 417256349487250392122120746762550, 11019, 0);
        _reserveERC20PoolHandler.settleAuction(818097782230726263131224806387432801887947892950801, 3, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC20PoolHandler.settleAuction(1045174129353233337547, 14962, 490775706239416317157126137000, 0);
        _reserveERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639934, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);
        _reserveERC20PoolHandler.removeQuoteToken(7138, 27260, 5841, 0);
        _reserveERC20PoolHandler.bucketTake(130086595647608623733586123, 0, false, 2, 0);
        _reserveERC20PoolHandler.pledgeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639933, 1, 0);
        _reserveERC20PoolHandler.settleAuction(877519612062733, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 3, 0);
    }

    /*
        Test was failing when collateral is added to 7388 bucket in settle
        Fixed by updating depositTime in invariants when collateral is added for borrower in 7388 bucket.
    */
    function test_regression_invariant_B5() external {
        _reserveERC20PoolHandler.settleAuction(115792089237316195423570985008687907853269984665640564039457584007913129639935, 3097951365082855701011892593056006, 28505541224098934564122193102646813744506286540202295861523654, 0);
        _reserveERC20PoolHandler.settleAuction(268023445355841172515900573198115553, 232461104934, 3, 0);

        invariant_Bucket_deposit_time_B5_B6_B7();
    }

    function test_regression_remove_collateral_R1() external {
        _reserveERC20PoolHandler.moveQuoteToken(3, 112642414612381, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 2, 318641953631952589414977894280024365632);
        _reserveERC20PoolHandler.bucketTake(182494113675724977281776140380971070728096798326637457234650826485, 117214647013297091537317197140644804056447612846311, true, 1904681890422957, 597521941940451948616669716374429304528665022989234078986136163808910103141);
        _reserveERC20PoolHandler.removeCollateral(3, 251744909376884114715, 2, 0);

        invariant_exchangeRate_R1_R2_R3_R4_R5_R6_R7_R8();
    }
}

contract RegressionTestReserveWith10BucketsERC20Pool is ReserveERC20PoolInvariants { 

    function setUp() public override { 
        // failures reproduced with 10 active buckets
        vm.setEnv("NO_OF_BUCKETS", "10");
        super.setUp();
    }

    function test_regression_10_buckets_reserves_exchange_rate() external {
        _reserveERC20PoolHandler.drawDebt(6520093117695692, 10502155266532607043273364294314284, 1098298774976985856973546303238);
        _reserveERC20PoolHandler.addCollateral(799413999404661436938800974130322989398660743689953725050361533512927, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _reserveERC20PoolHandler.addQuoteToken(1255508307403442885488346999776530100723982429883749097689986204842323, 265286955307553699, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 3);
        _reserveERC20PoolHandler.removeCollateral(2965235700463937713398460019097, 4895028025906346399626720847127, 3728128946475078059073833346505, 906504442015914621357139352779);

        invariant_exchangeRate_R1_R2_R3_R4_R5_R6_R7_R8();
    }

    function test_regression_10_buckets_reserves_fenwick_depositsTillIndex_F2() external {
        // this test pass with 3 buckets vm.setEnv("NO_OF_BUCKETS", "3");
        _reserveERC20PoolHandler.pullCollateral(1725238694, 5607861119407238108682743905764, 3697947221836192961852172220745);
        _reserveERC20PoolHandler.pledgeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 4163003353533717107712248278327, 3);
        _reserveERC20PoolHandler.pledgeCollateral(331051108471112814068505394235, 1794357362670427033443967539383, 5434760184066684970661380825914848);
        _reserveERC20PoolHandler.takeReserves(2093390169277455457120395826009, 225655960252256920594649467486, 420191481913388856379382341234);
        _reserveERC20PoolHandler.takeAuction(1000072601753449902, 6742594571340865561402752538156, 6185991641637615001992062400650, 2579004074292614487814817916190);
        _reserveERC20PoolHandler.moveQuoteToken(4379799846767962622058097964138, 4282396763100001034720772014232626, 5963803418953998430016013239158, 7396228690901613004007474991524, 796254125618203630857931805060);
        _reserveERC20PoolHandler.addCollateral(888898768883276460170629663497068, 716786772693430592538218347633574211299860345742396124898302617941098931, 3339070800417238370478910808909, 788108251185339569414458624308);
        _reserveERC20PoolHandler.removeCollateral(1089233309112608580, 2016088173856873109127353621467272, 4816638127778058080435479900912, 17394197214993611742051);
        _reserveERC20PoolHandler.pullCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639933, 2447848839490892868643621735058214832159901902455148010868708151771, 2);
        _reserveERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 29425834998902062728, 2815561902903892364700367145997869863083581937863, 0);
        _reserveERC20PoolHandler.takeAuction(1002082639411802781, 1000000141393972450, 2062329569865819338652496, 3639518374983970385625641369267);
        _reserveERC20PoolHandler.pullCollateral(716928335861873075224326450171091915803141636754600547146763478924688677, 6017014239243671152668202570617, 811528433232365724170352835761);
        _reserveERC20PoolHandler.kickWithDeposit(1006966022689012113631510, 2839423961165, 1012610096869894613);
        _reserveERC20PoolHandler.repayDebt(59697, 4218268651349607331917838812219315, 4198061940385182860329527760110561);
        _reserveERC20PoolHandler.addQuoteToken(9102590, 10619990735779382463268300515514058022851111, 1670387541301, 10508691425622217157731331015369006567594519374645329314842933480452519);
        _reserveERC20PoolHandler.settleAuction(0, 59960806476012009153510156995088168122, 2, 238483732749493419311882771922463500070384363806126829);
        _reserveERC20PoolHandler.repayDebt(1, 2686234748092207156, 100821654896808);
        _reserveERC20PoolHandler.repayDebt(181009111300787803171804491289802958, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 17);
        _reserveERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639932, 2, 174569101234346814190149980229336590921869440994501902536709);
        _reserveERC20PoolHandler.takeReserves(58323667455796458960119752251314, 999999999999999999996914159864440813004952921, 2414971389277316683224492871172);
        _reserveERC20PoolHandler.kickAuction(3, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 624349585752278917231152081294053644738674, 93866371540144105487879266738177937819573038841100);
        _reserveERC20PoolHandler.takeAuction(4009182895962590698169242, 1027990407286300256, 5767416410879431720916599990791, 4407902621924331080675140948337446);
        _reserveERC20PoolHandler.kickAuction(2665212666883282385351563849988, 3671051269384066725179739044196, 698810519264182935230648819185220104516393118, 2532667659084170710624920489511);
        _reserveERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639935, 67847457909646289591363578592322056020323327076484828692171208309696597165, 850058, 18301753154181254958465622305761670944);
        _reserveERC20PoolHandler.bucketTake(4899749608953023536728566927535, 1195705898947877847733236256196905, false, 3846324670787072290361799026507, 1895755726707090730202504915719);
        _reserveERC20PoolHandler.transferLps(1001555259040324866, 219983341601869521, 179994348168896996267584235984, 10938648711638122917574185928518, 6766351769155174805492401339267068);
        _reserveERC20PoolHandler.kickReserveAuction(115792089237316195423570985008687907853269984665640564039457584007913129639932, 210805673161421882841240320778627479);
        _reserveERC20PoolHandler.drawDebt(1576194744345532774068685102596, 1797313800, 1791527976146243688526195152423);
        _reserveERC20PoolHandler.takeReserves(115792089237316195423570985008687907853269984665640564039457584007913129639934, 3, 2);
        _reserveERC20PoolHandler.takeReserves(7473156297292164364442021004735, 28298835592766099474577065620, 4367231807488463594739598804132);
        _reserveERC20PoolHandler.moveQuoteToken(7428996156802457743983475024326, 340013001967490041612835676059, 4543539693481132121488275579733, 717078735389788372786880924893119953278634685058403423810552508405332820, 2747877709767875638682785092039);
        _reserveERC20PoolHandler.takeReserves(115792089237316195423570985008687907853269984665640564039457584007913129639935, 1199844344067318008016861893636238195, 1);
        _reserveERC20PoolHandler.takeReserves(7594217016957595273358984273232240986967, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 1);
        _reserveERC20PoolHandler.removeQuoteToken(2123674426112976590010963758042596163040978908500930465, 0, 1, 2);
        _reserveERC20PoolHandler.takeReserves(1000047442406905567, 617509245024506032895859547987, 5778018676208469410493025015732);
        _reserveERC20PoolHandler.addQuoteToken(35995929, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 2, 214362937278044814672278861604687139751920139426212338400);
        _reserveERC20PoolHandler.settleAuction(872, 12074647577213068558550804504672314313959440976957612, 36439400262778262906769930774880775814972449146877922483550300590102542, 318370212615296752719110675464569232142337676785721110080418244354575);
        _reserveERC20PoolHandler.repayDebt(123266242330573767, 1035733068352764981, 120671020103695083742903620763960);
        _reserveERC20PoolHandler.removeCollateral(1000000319538407292, 2008341881791431479843343, 899102818114014511971899123461, 3959387048639002356932220155605);
        _reserveERC20PoolHandler.takeAuction(1005295756215100198864026, 1760280839764147909673794710032, 789352182639308272, 1001105712307015464574634072744);
        _reserveERC20PoolHandler.drawDebt(2113416239727263773814576784034, 1161073618109393929, 547205239944875850370679274);
        _reserveERC20PoolHandler.drawDebt(2, 3636705783259448516133156662357670309067, 285616183869066432501692845851878691729755138784635485991695);
        _reserveERC20PoolHandler.takeAuction(2715404242808797632081341083084837565723704868026, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0, 39793392840327830820680401190667337);
        _reserveERC20PoolHandler.kickReserveAuction(115792089237316195423570985008687907853269984665640564039457584007913129639933, 1531077172191020224002333744440866354388080814127358767374637012209269972664);
        _reserveERC20PoolHandler.settleAuction(7790077719981479902654711497260, 2203631374956410123461336421893, 916448996305574847264791904981, 1002133809706456504575372);
        _reserveERC20PoolHandler.withdrawBonds(3700130040914704759363595235214, 1030675064964112851, 1005519911429581350);
        _reserveERC20PoolHandler.moveQuoteToken(3915432646857867035114192405496, 4609404034339185572358252520081, 9007969379188124973120136273189, 731419523757918578, 94166848144089645562304450222);
        _reserveERC20PoolHandler.removeCollateral(3, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 675223079871355811436762729810330880280120, 2140814967183482480681884235946420360133390088730);
        _reserveERC20PoolHandler.takeAuction(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 177958195847343072440954347149552735);
        _reserveERC20PoolHandler.bucketTake(525644741809339749554203, 7869337152450762415516057420200, false, 3897880605063230242599616831067, 3700431326419314223980729493053);
        _reserveERC20PoolHandler.removeCollateral(2000832567864949824297396248339, 908182074171726670379604432310, 2491454627421088713029519972361, 1000006612673653339);
        _reserveERC20PoolHandler.addCollateral(808594806729699629112134281330, 3877057354969661475686284185325, 9086784489686696949716435672881, 992456795310749116943374893755);
        _reserveERC20PoolHandler.withdrawBonds(1000000012872576761580818, 1590119390558557540599116692806, 33364766054018154844710959877);
        _reserveERC20PoolHandler.takeReserves(62418894493561534878, 184295902472986082251384281776735221531678582045202848, 2);
        _reserveERC20PoolHandler.transferLps(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 1, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _reserveERC20PoolHandler.removeCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 1, 42019400363510559466713945056402714606538140568246384014480110914328265163403);
        _reserveERC20PoolHandler.settleAuction(1057279804021938190, 246687658464793724986455352391, 5925827996077694552730400457343, 2084381812461048011473064757225);
        _reserveERC20PoolHandler.kickReserveAuction(214359998882822941400036836759, 772237151693507486089823656752);
        _reserveERC20PoolHandler.kickWithDeposit(580502608968719507145237660113965916868063012, 1, 2);
        _reserveERC20PoolHandler.withdrawBonds(1, 1, 869697374638745867981687493872400658574867528089570078229036174);
        _reserveERC20PoolHandler.addCollateral(2835013280595323711754, 1379747638539802930158795366740, 2999260289280542828859825661600, 1111505902930696308);
        _reserveERC20PoolHandler.transferLps(101318005368562086532090860441, 727691276523922201026494539, 999999999999998209545201949951385339923831640, 2625186857895955159432498610976, 1008568104827895584797314);
        _reserveERC20PoolHandler.takeAuction(108221678869582869958545780, 869196763401261087493999826401, 3017908586652896026183849934632, 1025465081213741246);
        _reserveERC20PoolHandler.transferLps(48795152523476684116952182940, 433417159535039233355211014431, 1672322436938904502828626028960, 1089265766493498060383870046015307, 1000000315952461027);
        _reserveERC20PoolHandler.removeQuoteToken(210566583091, 35967496172865341668096611623330616365711619715451093333, 351, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _reserveERC20PoolHandler.settleAuction(1, 26046038938573022881778996231552706821552625849703911370781119255688992648171, 33703319315472791056, 96780568387179063244580652852700750875077793);
        _reserveERC20PoolHandler.kickAuction(1, 185285446, 378697901814982286731, 0);

        invariant_fenwick_depositsTillIndex_F2();
    }

    function test_regression_10_buckets_reserves_RE() external {
        // this test fails with 3 buckets too vm.setEnv("NO_OF_BUCKETS", "3");
        _reserveERC20PoolHandler.drawDebt(290017231884009828565779120576, 1002346974105628138843242095525, 1653584878177848176194377074799);
        _reserveERC20PoolHandler.pledgeCollateral(1, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 0);
        _reserveERC20PoolHandler.drawDebt(3672889067541591, 17, 83856721931010423002279627799971306025841049042329947);
        _reserveERC20PoolHandler.bucketTake(1000197316935676153, 3096097749449943758920050453756, false, 2824023740736482172369426325793, 1777694503);
        _reserveERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, 64603456943647345, 22726223561335484363204986876705771);
        _reserveERC20PoolHandler.kickWithDeposit(115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _reserveERC20PoolHandler.settleAuction(5448707427889081580045157214016, 898517806662526225, 57255705446025176430893986032941, 1798503358);
        _reserveERC20PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639933, 338902, 24895432670362520003757781937901496507349044);
        _reserveERC20PoolHandler.takeAuction(253339908492728, 17277739980789095840457279982793255431547403624057861740152922, 2, 47882133371720379988628201061591263125271753131194);
        _reserveERC20PoolHandler.settleAuction(2753283363779176472273, 25608716488622741794441581974264544214953846896, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _reserveERC20PoolHandler.kickAuction(19414070578865673973718167627323950328762130421, 101199815046304851350471242729, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 8007554645229363487529300028025230736429643245034385208137923);
        _reserveERC20PoolHandler.kickAuction(12562041944730213876401507392536536171693897323265736340132124, 542653972998765405218543635289786883927326994341381904010685021072255, 3, 9233918920157136119146);
        _reserveERC20PoolHandler.moveQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 1462574483700643795161756098043989899405507099055518688993);
        _reserveERC20PoolHandler.takeReserves(1, 0, 2);
        _reserveERC20PoolHandler.removeQuoteToken(14730140957608857, 99, 1, 1386705920515328814743931560931167479097551832850008218878487983494150);
        _reserveERC20PoolHandler.kickReserveAuction(1, 115792089237316195423570985008687907853269984665640564039457584007913129639935);
        _reserveERC20PoolHandler.kickWithDeposit(893008286811460788553031904481952573606214832422259596085940570283982304, 0, 115792089237316195423570985008687907853269984665640564039457584007913129639934);
        _reserveERC20PoolHandler.takeReserves(3, 170439307069053886557145191896703842826953837742170479, 20466465501556948674803401059840117427266555527646887);
        _reserveERC20PoolHandler.moveQuoteToken(24576850282145403341840304023303746575460022097947982029320014455, 199259095182280921249849, 3, 263081299123519591374903422280598171358315911105268634044959571252407, 107705715799261820459195895645732878612286692246405740446896247929123014);
        _reserveERC20PoolHandler.pullCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639935, 5504186113825436176758787846084168342878, 41473922375020639787670112003);
        _reserveERC20PoolHandler.addQuoteToken(7325, 2954833337023190538516242662284, 3367433177587846034146701567789, 787975225899906627970764104528);
        _reserveERC20PoolHandler.kickReserveAuction(789506806945947781973395839889873837801852027965244395560074620825525209, 7343029460976070011573595981514);
        _reserveERC20PoolHandler.takeAuction(1656596873830407787820916, 3688617597270095107887598723154497, 3278933088712828438944086868109846421171441741587847203531235677181, 1000047204802117783);
        _reserveERC20PoolHandler.kickAuction(16498486372578893979959279149, 102495710679400630, 2012171589600623221362832941245, 10959);
        _reserveERC20PoolHandler.addQuoteToken(2206172833895134654629140542579, 38495, 437987353745559351, 9989828001206899429812877610175);
        _reserveERC20PoolHandler.kickAuction(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 19510935589660207977979858847329461893234305550956273506030315504509452499293, 5618426840076102374407720);
        _reserveERC20PoolHandler.kickAuction(1005012487396868295, 58890819279122694863, 1777723313, 451036903866146529372826612192);
        _reserveERC20PoolHandler.removeQuoteToken(578054643634385875382779806883, 995986024390026689599325420880, 1212208052270684631, 915932822573274712433002209298);
        _reserveERC20PoolHandler.bucketTake(58452, 7989451717336466463163480737395323769105157546, true, 0, 2982422632369226214652442581962969444852761193327330692572341854);
        _reserveERC20PoolHandler.addCollateral(4327795945510946329857323835558, 2280002616451219951843777766825, 2753935105800702192896442118, 1000014897118126606048973);
        _reserveERC20PoolHandler.settleAuction(115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 572852888739807418847637975133051259849108089150193598633);
        _reserveERC20PoolHandler.takeReserves(115792089237316195423570985008687907853269984665640564039457584007913129639933, 2, 1);
        _reserveERC20PoolHandler.takeAuction(45608808137377086275068272517449173969266654744680237931555660529240, 922695446816283437904427175331876, 2808969292961465493746792392245575585431291270031, 3);
        _reserveERC20PoolHandler.takeReserves(23516087622120187750393524991337377, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _reserveERC20PoolHandler.addQuoteToken(1771380905134061495159586519375, 962424168217907571086988979439, 2705737892325074800408, 310383682458910402);
        _reserveERC20PoolHandler.addQuoteToken(1125592372237565614088627104066, 5423140408463152948915224198927, 65057536008684882637316853646, 5270294277016808585300236482301393);
        _reserveERC20PoolHandler.bucketTake(1883531208, 1044596597307435994, false, 1148561174557185377480250370, 1724803952);
        _reserveERC20PoolHandler.settleAuction(6764815468945041250411727809692, 877, 2, 3004121113053304893931411185);
        _reserveERC20PoolHandler.drawDebt(17, 699675949875749350477881784726699749036129541037, 26378247963);
        _reserveERC20PoolHandler.addCollateral(115792089237316195423570985008687907853269984665640564039457584007913129639932, 29302100276668979277192554575067413969929213158376793, 2, 115792089237316195423570985008687907853269984665640564039457584007913129639932);
        _reserveERC20PoolHandler.removeQuoteToken(1000000000936215753, 254605325365626694, 4069, 1035856500028837119);
        _reserveERC20PoolHandler.kickAuction(1000090607229722934, 2580171788160363207026734674037, 1347092665025078310051154421986979, 1004037368521554395568163);
        _reserveERC20PoolHandler.takeReserves(923522243225703254994721298870, 8700115546393917263343357543619, 2166428961936462402557439595392582);
        _reserveERC20PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 3, 639402091975833721492394191878388806085281852328);
        _reserveERC20PoolHandler.takeAuction(2, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 1);
        _reserveERC20PoolHandler.kickReserveAuction(1192029264782433734511278767050585798022919741840914701707701, 9838660868733061321749714698638583897632565681053207160200164948032353326111);
        _reserveERC20PoolHandler.kickWithDeposit(848911323651847292018922493625, 475461101841015439785306204553, 5038495789764551021097736053014);

        invariant_reserves_RE1_RE2_RE3_RE4_RE5_RE6_RE7_RE8_RE9_RE10_RE11_RE12();
    }
}