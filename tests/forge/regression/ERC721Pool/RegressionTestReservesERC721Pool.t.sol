// SPDX-License-Identifier: UNLICENSED

pragma solidity 0.8.14;

import { ReserveERC721PoolInvariants } from "../../invariants/ERC721Pool/ReserveERC721PoolInvariants.t.sol";

contract RegressionTestReserveERC721Pool is ReserveERC721PoolInvariants { 
    function setUp() public override { 
        super.setUp();
    }

    function test_regression_arithmetic_overflow() external {
        _reserveERC721PoolHandler.takeAuction(92769370221611464325146803683156031925894702957583423527130966373453460, 1, 0, 0);
        _reserveERC721PoolHandler.bucketTake(946681003919344525962988194461032341334826191474892406752540091475466732435, 115792089237316195423570985008687907853269984665640564039457584007913129639932, false, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 0);
        _reserveERC721PoolHandler.pledgeCollateral(110349606679412691172957834289542550319383271247755660854362242977991410022199, 14546335109189328620313099, 0);
        _reserveERC721PoolHandler.transferLps(7966696646007323951141060300, 1382000000000000000000, 14900528365458273129607000593, 18640181410506725405733865833824324648215384731482764797343269315726072943072, 0);
        _reserveERC721PoolHandler.drawDebt(107285134268485238885825019843523094619958942033886535891203702184170570337916, 1008096043491529984, 0);
        _reserveERC721PoolHandler.bucketTake(0, 1177, true, 698469034333322743784201375142656365110267526102696086972, 0);
    }

    function test_regression_CT4_1() external {
        _reserveERC721PoolHandler.takeAuction(12081493032056306060837676478, 17112687674220907985671783478, 156086231189053706777082702350822415, 0);
        _reserveERC721PoolHandler.bucketTake(2751921977392940485992662421841654754784896, 0, false, 74485124857288266409128701303509478629061526535257123857425657075, 0);
        _reserveERC721PoolHandler.settleAuction(28196, 350662677223461989004552717744870304232548804666, 36769010933687420804596073, 0);
        _reserveERC721PoolHandler.bucketTake(83908, 44550000000000000, false, 20000000000000000000000312288, 0);

        invariant_CT4();
    }

    function test_regression_CT4_2() external {
        _reserveERC721PoolHandler.drawDebt(0, 3, 0);
        _reserveERC721PoolHandler.addQuoteToken(110722066303045195479382873847756822996893052638415787811385263327686542008, 2595467720355805256177, 44804955487212801727231000414524018578, 0);
        _reserveERC721PoolHandler.moveQuoteToken(43739203749898257092507987414800731, 45406433371816793948702636, 12374955966170596958032853251, 781, 0);
        _reserveERC721PoolHandler.moveQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 1, 61586, 11856671202668897206441691542968611274078091901056358965450125, 0);
        _reserveERC721PoolHandler.pledgeCollateral(349513993113487194057973, 362746040314235282459383005583790844, 0);
        _reserveERC721PoolHandler.settleAuction(3, 2, 3, 0);

        invariant_CT4();
    }

    function test_regression_CT2_2() external {
        _reserveERC721PoolHandler.addQuoteToken(3, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 3, 0);
        _reserveERC721PoolHandler.repayDebt(47903824342862105100722366, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 0);
        _reserveERC721PoolHandler.moveQuoteToken(14954617124484181050069718572841414619329, 4019052775, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 18404722369483097182428514137726899016323228344857237503694710754857187987, 0);
        _reserveERC721PoolHandler.repayDebt(8642195270788292, 115792089237316195423570985008687907853269984665640564039457584007913129639935, 0);
        _reserveERC721PoolHandler.kickAuction(37599242352987749812798760790120682114398140522946909699266021534073157156, 115792089237316195423570985008687907853269984665640564039457584007913129639934, 42022531711777130710006520923822265578840019061180471553959992811, 0);
        _reserveERC721PoolHandler.drawDebt(12048316057, 12017048940743955664316982882044887141128535965, 0);
        _reserveERC721PoolHandler.removeQuoteToken(17773795768966620525, 1047143, 54863162, 0);
        _reserveERC721PoolHandler.withdrawBonds(115792089237316195423570985008687907853269984665640564039457584007913129639933, 3, 0);
        _reserveERC721PoolHandler.takeAuction(2698759183557, 47540095330112933707821447439580287140189201532316467969464, 28821914686174180822501529566772569775778735295453392587173140587, 0);
        _reserveERC721PoolHandler.repayDebt(11851070455092288342427255581330021498615848370966979414877793886456318988205, 20000469912106847714032076597, 0);
        _reserveERC721PoolHandler.pullCollateral(9906355507789251046177658200, 789628541711133703256041458103535389653400352665407731094226888831, 0);
        _reserveERC721PoolHandler.drawDebt(0, 5711299, 0);
        _reserveERC721PoolHandler.takeReserves(52580967332816855446614075396003761174408900540583074540513, 3066371283933430634405115377931952568434121552, 0);
        _reserveERC721PoolHandler.moveQuoteToken(187, 10746658534810329994020169146, 26326378734592892198504991, 3678, 0);
        _reserveERC721PoolHandler.kickWithDeposit(9347, 1019767997450901378, 0);
        _reserveERC721PoolHandler.pullCollateral(0, 1727508752834082423180670412007678522620836706739773785431403804, 0);
        _reserveERC721PoolHandler.addQuoteToken(10272927241872097800945271290053605104341355430184682823901929, 133408017309487439448075733, 17099185418125710911451484450376088, 0);
        _reserveERC721PoolHandler.drawDebt(448053659500389508982384470106829047, 1400284447444730491147774097, 0);
        _reserveERC721PoolHandler.removeQuoteToken(10288285818208197682336817035, 45968783023960545347406014687, 691, 0);
        _reserveERC721PoolHandler.settleAuction(154, 860492567187269218261780934935914770288503137169306025450164292967, 463633433497382452344200590293648002678143898236, 0);

        invariant_CT2();
    }

    /*
        Test was failing due to buckets where quote tokens are added through `mergeCollateral` handler were not considered in F2 invariant
        Fixed by considering all buckets in invariants and changing `fenwickSumTillIndex` method
    */
    function test_regression_invariant_F2() external {
        _reserveERC721PoolHandler.pledgeCollateral(3, 3249247182472647789271370143468153988911, 0);
        _reserveERC721PoolHandler.takeAuction(3, 68002012319987217885680836087921689752254473803305406, 3, 0);
        _reserveERC721PoolHandler.mergeCollateral(280792061588141829088525786592236158704094119781363060);

        invariant_fenwick_depositAtIndex_F1();
        invariant_fenwick_depositsTillIndex_F2();
    }

    /*
        Test was failing when partial collateral is added in bucket for borrower after borrower becomes collateralized
        Fixed by updating depositTime in 'takeAuction' handler when collateral is added for borrower in bucket.
    */
    function test_regression_invariant_B5() external {
        _reserveERC721PoolHandler.withdrawBonds(29901450120321179040232647, 33707253840165794915329047600407010147409078919505035384547761916581261664771, 64256482982762173601681848012735492443236160824527223136253084902273448022922);
        _reserveERC721PoolHandler.removeQuoteToken(1035551263513576830, 41740568139652812265713570158854588029242418548921997608771244687820831484709, 71044, 62590313429503445735623493678970090625742913234641758074604729049807113894487);
        _reserveERC721PoolHandler.settleAuction(1, 0, 268121947844, 1);
        _reserveERC721PoolHandler.addQuoteToken(115792089237316195423570985008687907853269984665640564039457584007913129639934, 115792089237316195423570985008687907853269984665640564039457584007913129639932, 2, 0);
        _reserveERC721PoolHandler.takeAuction(106448808771037447301803820926416226252394847235491597014603888747398433951911, 77069574318109684248039198042740367334616176706977431797535974098463346496942, 77528075296808727840369101218435242378516990509439357003969850559946810538911, 6444651742970749586626021422362454367627580772250065944299506552651206353728);
        _reserveERC721PoolHandler.drawDebt(115792089237316195423570985008687907853269984665640564039457584007913129639933, 2, 285525856813675343840641688174225684908631009);
        _reserveERC721PoolHandler.drawDebt(0, 115792089237316195423570985008687907853269984665640564039457584007913129639933, 2);
        _reserveERC721PoolHandler.settleAuction(3, 132142413661373040125626290113760150183940291131, 123613323046465865910874738151644490943543283029000699929340077966695767, 1981041880214457766957806662399378912);
        _reserveERC721PoolHandler.settleAuction(85528495297011614367290117735627897273430599924159987514558136255281351756656, 51899086351157718719907596611713215459672847846628811043751547933087535149139, 6017, 32356);
        _reserveERC721PoolHandler.moveQuoteToken(41852115601722687085018, 838, 110349606679412691172957834289542550319383271247755660854362242977991410021116, 10708, 1000147102256879879);
        _reserveERC721PoolHandler.takeAuction(65083383064492179858552362056041108711907790400214219220470719778313668067918, 47044205696979556241773847817964719479426890797480386218806479041076417646753, 49891310239897651922054921325833048160713517515033725083348033871686585409233, 113036808365357047396163273250845284856347394197766632691494752070902864551847);

        invariant_Bucket_deposit_time_B5_B6_B7();
    }
}
